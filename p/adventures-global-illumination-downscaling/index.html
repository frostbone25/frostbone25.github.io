<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Sharing my notes, and experiments with optimizing my real-time Global Illumination lighting buffers."><title>Global Illumination Downscaling</title><link rel=canonical href=https://frostbone25.github.io/p/adventures-global-illumination-downscaling/><link rel=stylesheet href=/scss/style.min.833d6eed45de56f48306bf57268d5b8cdfc8a60e8e7bdc99810464fcd033f7c6.css><meta property='og:title' content="Global Illumination Downscaling"><meta property='og:description' content="Sharing my notes, and experiments with optimizing my real-time Global Illumination lighting buffers."><meta property='og:url' content='https://frostbone25.github.io/p/adventures-global-illumination-downscaling/'><meta property='og:site_name' content='David Matos'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Unity3D'><meta property='article:tag' content='Diffuse'><meta property='article:tag' content='Global Illumination'><meta property='article:tag' content='Lighting'><meta property='article:tag' content='Upsampling'><meta property='article:published_time' content='2026-01-07T00:00:00+00:00'><meta property='article:modified_time' content='2026-01-07T00:00:00+00:00'><meta property='og:image' content='https://frostbone25.github.io/p/adventures-global-illumination-downscaling/content/final-rendered-image.png'><meta name=twitter:title content="Global Illumination Downscaling"><meta name=twitter:description content="Sharing my notes, and experiments with optimizing my real-time Global Illumination lighting buffers."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://frostbone25.github.io/p/adventures-global-illumination-downscaling/content/final-rendered-image.png'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_4dd1a7adeca92f6.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>David Matos</a></h1><h2 class=site-description>XR Software Engineer</h2></div></header><ol class=menu-social><li><a href=https://github.com/frostbone25 target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/contact-/-links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Contact / Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><ol><li><ol><li><a href=#table-of-contents>Table of Contents</a></li></ol></li></ol></li><li><a href=#preface>Preface</a></li><li><a href=#upsampling>Upsampling</a><ol><li><a href=#upsampling---chain-setup>Upsampling - Chain Setup</a></li><li><a href=#upsampling---the-basics-point-bilinear>Upsampling - The Basics (Point, Bilinear)</a></li><li><a href=#upsampling---wider-blur-filters>Upsampling - Wider Blur Filters</a></li><li><a href=#upsampling---depth-aware>Upsampling - Depth Aware</a></li><li><a href=#upsampling---depth-and-normal-aware>Upsampling - Depth and Normal Aware</a><ol><li><a href=#optimization-bonus>Optimization Bonus</a></li></ol></li></ol></li><li><a href=#temporal-instabilities>Temporal Instabilities</a><ol><li><a href=#temporal-instability-solutions-temporal-filtering>Temporal Instability Solutions: Temporal Filtering?</a></li><li><a href=#investigations-into-temporal-instabilities>Investigations into Temporal Instabilities</a></li><li><a href=#temporal-instability-solutions-downsampling>Temporal Instability Solutions: Downsampling?</a></li><li><a href=#downsampling---drawbacks>Downsampling - Drawbacks</a><ol><li><a href=#temporal-solution-comparisons>Temporal Solution Comparisons</a></li></ol></li></ol></li><li><a href=#upsampling---how-to-go-further>Upsampling - How to go further?</a><ol><li><a href=#spherical-harmonics>Spherical Harmonics</a></li><li><a href=#spherical-harmonics-how-to-apply-it>Spherical Harmonics: How to apply it?</a></li><li><a href=#spherical-harmonic-optimizations-compute-shader>Spherical Harmonic Optimizations: Compute Shader</a></li><li><a href=#spherical-harmonic-optimizations-render-target-packing>Spherical Harmonic Optimizations: Render Target Packing</a></li><li><a href=#spherical-harmonic-bonuses>Spherical Harmonic Bonuses</a></li></ol></li><li><a href=#future-how-to-go-even-further-and-beyond>Future: How to go even further and beyond?</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/adventures-global-illumination-downscaling/><img src=/p/adventures-global-illumination-downscaling/content/final-rendered-image_hu_9a3f92b842afb8c8.png srcset="/p/adventures-global-illumination-downscaling/content/final-rendered-image_hu_9a3f92b842afb8c8.png 800w, /p/adventures-global-illumination-downscaling/content/final-rendered-image_hu_3b4eb901830b5e9a.png 1600w" width=800 height=475 loading=lazy alt="Featured image of post Global Illumination Downscaling"></a></div><div class=article-details><header class=article-category><a href=/categories/graphics/>Graphics</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/adventures-global-illumination-downscaling/>Global Illumination Downscaling</a></h2><h3 class=article-subtitle>Sharing my notes, and experiments with optimizing my real-time Global Illumination lighting buffers.</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2026-01-07T00:00:00Z>Jan 07, 2026</time></div></footer></div></header><section class=article-content><p><em>By: David Matos</em></p><p>Sharing personal my notes, and experiments with optimizing my real-time Global Illumination lighting buffers. The main goal is to reduce the rendering cost while maximizing final image quality and stability.</p><p><img src=/p/adventures-global-illumination-downscaling/content/final-rendered-image.png width=1201 height=713 srcset="/p/adventures-global-illumination-downscaling/content/final-rendered-image_hu_1e7b75b76c854ae0.png 480w, /p/adventures-global-illumination-downscaling/content/final-rendered-image_hu_40790665f174e8e8.png 1024w" loading=lazy alt=final-rendered-image class=gallery-image data-flex-grow=168 data-flex-basis=404px>
<em><a class=link href=https://www.fab.com/listings/ce956075-e76c-4374-94a7-ea6226ae00de target=_blank rel=noopener>Japanese Urban City Night Pack Environment</a> in Unity</em></p><h4 id=table-of-contents><a href=#table-of-contents class=header-anchor></a>Table of Contents</h4><ul><li><a class=link href=#preface>Preface</a></li><li><a class=link href=#upsampling>Upsampling</a><ul><li><a class=link href=#upsampling---chain-setup>Upsampling - Chain Setup</a></li><li><a class=link href=#upsampling---the-basics-point-bilinear>Upsampling - The Basics (Point, Bilinear)</a></li><li><a class=link href=#upsampling---wider-blur-filters>Upsampling - Wider Blur Filters</a></li><li><a class=link href=#upsampling---depth-aware>Upsampling - Depth Aware</a></li><li><a class=link href=#upsampling---depth-and-normal-aware>Upsampling - Depth and Normal Aware</a></li></ul></li><li><a class=link href=#temporal-instabilities>Temporal Instabilities</a><ul><li><a class=link href=#temporal-instability-solutions-temporal-filtering>Temporal Instability Solutions: Temporal Filtering?</a></li><li><a class=link href=#investigations-into-temporal-instabilities>Investigations into Temporal Instabilities</a></li><li><a class=link href=#temporal-instability-solutions-downsampling>Temporal Instability Solutions: Downsampling?</a></li><li><a class=link href=#downsampling---drawbacks>Downsampling - Drawbacks</a></li><li><a class=link href=#temporal-solution-comparisons>Temporal Solution Comparisons</a></li></ul></li><li><a class=link href=#upsampling---how-to-go-further>Upsampling - How to go further?</a><ul><li><a class=link href=#spherical-harmonics>Spherical Harmonics</a></li><li><a class=link href=#spherical-harmonics-how-to-apply-it>Spherical Harmonics: How to apply it?</a></li><li><a class=link href=#spherical-harmonic-optimizations-compute-shader>Spherical Harmonic Optimizations: Compute Shader</a></li><li><a class=link href=#spherical-harmonic-optimizations-render-target-packing>Spherical Harmonic Optimizations: Render Target Packing</a></li><li><a class=link href=#spherical-harmonic-bonuses>Spherical Harmonic Bonuses</a></li></ul></li><li><a class=link href=#how-to-go-even-further-and-beyond>How to go even further and beyond?</a></li><li><a class=link href=#references--sources>References / Sources</a></li></ul><h2 id=preface><a href=#preface class=header-anchor></a>Preface</h2><p>In a Real-Time rendering context, when computing any image-space effects, <strong>it&rsquo;s very common as a performance measure to never compute those effects at full screen resolution.</strong> The reason for this is simple, the more pixels we have, the more work we do.</p><p>Say our final target resolution is <code>1920 x 1080</code>. Using this resolution will equate to&mldr; <code>1920 x 1080 = 2,073,600 pixels</code></p><p>That is a lot of pixels! Now what you need to consider is that when doing things at this target resolution <em>(for each of these 2 million pixels)</em> you are going to run a set of shader instructions/operations for every pixel, for the given effect.</p><p>For some light-weight effects like bloom, or tonemapping the amount of overall work that you&rsquo;ll be doing per pixel is fairly small.</p><p>However for more complicated effects like SSAO <em>(Screen-Space Ambient Occlusion)</em>, SSR <em>(Screen Space Reflections)</em>, or full on lighting buffers for Global Illumination <em>(either using Ray-Tracing, Voxel Cone-tracing, etc.)</em> The amount of overall work needed for those effects is significant.</p><p><img src=/p/adventures-global-illumination-downscaling/content/vct-full-res.png width=1201 height=713 srcset="/p/adventures-global-illumination-downscaling/content/vct-full-res_hu_297d2d9ae0582ae6.png 480w, /p/adventures-global-illumination-downscaling/content/vct-full-res_hu_7a9f970a90468457.png 1024w" loading=lazy alt=vct-full-res class=gallery-image data-flex-grow=168 data-flex-basis=404px>
<em>Full Resolution Global Illumination (Voxel Cone Tracing)</em></p><p>The end result is that for a large amount of total pixels, you end up doing a large amount of work and your overall performance plummets.</p><p>You can cut back on the amount of work you do per pixel, which is a viable strategy. Unfortunately though with most of these effects/algorithims you can only simplify it so much. The work is required in order to do the effect in the first place.</p><p>So if you can&rsquo;t reduce the amount of work you do per-pixel, you can reduce the amount of pixels that we do work for in the first place. It&rsquo;s the easiest and also the most effective strategy.</p><p>Again our target resolution is <code>1920 x 1080 = 2,073,600 pixels</code>. If we reduce the target resolution by half we wind up with the following&mldr;</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Full Width:  1920
</span></span><span class=line><span class=cl>Full Height: 1080
</span></span><span class=line><span class=cl>Half Width:  (1920 / 2) = 960
</span></span><span class=line><span class=cl>Half Height: (1080 / 2) = 540
</span></span><span class=line><span class=cl>Final Resolution: 960 x 540 = 518,400 pixels
</span></span></code></pre></td></tr></table></div></div><p>Down from 2 million pixels, to just 500 thousand. That is a pretty nice cost saving! We cut down the amount of work we were doing by half! What happens if we go further by going down a quarter?</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Full Width:     1920
</span></span><span class=line><span class=cl>Full Height:    1080
</span></span><span class=line><span class=cl>Half Width:     (1920 / 2)  = 960
</span></span><span class=line><span class=cl>Half Height:    (1080 / 2)  = 540
</span></span><span class=line><span class=cl>Quarter Width:  (960  / 2)  = 480
</span></span><span class=line><span class=cl>Quarter Height: (540  / 2)  = 270
</span></span><span class=line><span class=cl>Final Resolution: 480 x 270 = 129,600 pixels
</span></span></code></pre></td></tr></table></div></div><p>Sweet! From 500 thousand to now just a little over a 100 thousand pixels. That is a massive reduction, factor in the work needed for every pixel we end up with a pretty significant reduction in our final workload needed for the effect.</p><p><em>(NOTE: I would like to point out that there are definetly a lot of over-generalizations that is happening here with this example. Obviously there are some caveats and edge cases as always&mldr; but the concept remains the same. The less work you have to do, the better your performance).</em></p><p>However&mldr; as attractive as the numbers and instruction counts come out to be, this does come with it&rsquo;s own set of tradeoffs.</p><p><img src=/p/adventures-global-illumination-downscaling/content/vct-4th-point-raw.png width=1201 height=713 srcset="/p/adventures-global-illumination-downscaling/content/vct-4th-point-raw_hu_4beee7171e24ce08.png 480w, /p/adventures-global-illumination-downscaling/content/vct-4th-point-raw_hu_40235cc71476ad63.png 1024w" loading=lazy alt=vct-4th-point-raw class=gallery-image data-flex-grow=168 data-flex-basis=404px>
<em>Raw 1/4th Resolution Diffuse Global Illumination (Voxel Cone Tracing)</em></p><p>Optimization is a game of tradeoffs, and reducing resolution will introduce some problems&mldr;</p><ul><li>Increase the size of pixels, which means increased aliasing/pixelation artifacts.</li><li>Depending on the effect, misalignment of parts of the image no longer align fully with the original.</li><li>Decreased temporal stability with the pixels being much larger, so the more the final pixel value changes between frames the more flickering and instability occurs.</li></ul><p>Yikes!</p><p>If your effects don&rsquo;t need to utilize scene depth/normal or any other related buffers this might be fine. But for my case where I&rsquo;m calculating a lighting buffer that large parts of my project will be lit by&mldr; this is not good at all. We can&rsquo;t use this as is, so we need to do some work in order to make it usable.</p><p>But wait&mldr; didn&rsquo;t we also mention that we were trying to reduce the workload in the first place per pixel? Yeah&mldr; and this is where the true difficulties of optimization come in. It&rsquo;s a game of tradeoffs, so you need to be careful when doing the work needed to make something usable, because you might end up doing more work in the end than it was to just render the effect at a better resolution in the first place!</p><p>So what can we do? Well fortunately&mldr; the industry has come up with many solutions that we can employ here to squeeze some more juice out of these shrunken fruits without exploding the final costs.</p><h2 id=upsampling><a href=#upsampling class=header-anchor></a>Upsampling</h2><p>The basic idea with upsampling in this context is to &ldquo;cheat&rdquo; by essentially creating more data, without actually calculating more data. In our case with images we are trying to create more pixels, without actually calculating all of those new pixels <em>(At least not using the original heavy way to calculate those pixels, because it was expensive to begin with!)</em>.</p><p>It&rsquo;s also important to note here that we will be covering classic upsampling methods that exist, not machine learning-based techniques like DLSS, FSR, Intel XeSS, etc.</p><p>While the end goal is the same, those technologies are aimed at upsampling a final rendered image <em>(not an image within the pipeline that is to help with the final rendered image)</em>, and are usually quite heavy.</p><h3 id=upsampling---chain-setup><a href=#upsampling---chain-setup class=header-anchor></a>Upsampling - Chain Setup</h3><p>I would also like to preface that these upsamples happen in multiple stages, it is not one single pass. This is by design and intentional in order to maximize pixel coverage and performance.</p><p>If you have done blur effects, you understand that it&rsquo;s common to do blur effects in two passes. For example if your doing a wide blur that spans across 32 pixels in each direction, you do it in two passes.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-HLSL data-lang=HLSL><span class=line><span class=cl><span class=c1>//Blur Pass 1 (Horizontal Pass)</span>
</span></span><span class=line><span class=cl><span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mo>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>32</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//spread pixels around horizontally</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//||||||||||||||||||||||||||||||||||||||||||</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//Blur Pass 2 (Vertical Pass)</span>
</span></span><span class=line><span class=cl><span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mo>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>32</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//reusing the previous horizontal blurred render target</span>
</span></span><span class=line><span class=cl>    <span class=c1>//spread pixels around vertically...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//||||||||||||||||||||||||||||||||||||||||||</span>
</span></span><span class=line><span class=cl><span class=c1>//End Result</span>
</span></span><span class=line><span class=cl><span class=c1>//(32 + 32) = 64 samples</span>
</span></span></code></pre></td></tr></table></div></div><p>Versus in a single pass, the amount of samples you end up doing is multiplicative&mldr;</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-HLSL data-lang=HLSL><span class=line><span class=cl><span class=c1>//Single-Pass Blur</span>
</span></span><span class=line><span class=cl><span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mo>0</span><span class=p>;</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=mi>32</span><span class=p>;</span> <span class=n>x</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>y</span> <span class=o>=</span> <span class=mo>0</span><span class=p>;</span> <span class=n>y</span> <span class=o>&lt;</span> <span class=mi>32</span><span class=p>;</span> <span class=n>y</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>float2</span> <span class=n>offset</span> <span class=o>=</span> <span class=kt>float2</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span> <span class=o>*</span> <span class=n>TexelSize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>//spread pixels around horizontally and vertically...</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//||||||||||||||||||||||||||||||||||||||||||</span>
</span></span><span class=line><span class=cl><span class=c1>//End Result</span>
</span></span><span class=line><span class=cl><span class=c1>//(32 x 32) = 1024 samples!!!</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/adventures-global-illumination-downscaling/content/graphic-blur-multistage.png width=1920 height=1080 srcset="/p/adventures-global-illumination-downscaling/content/graphic-blur-multistage_hu_66783ae5f540ddce.png 480w, /p/adventures-global-illumination-downscaling/content/graphic-blur-multistage_hu_7b0df871eb49451b.png 1024w" loading=lazy alt=graphic-blur-multistage class=gallery-image data-flex-grow=177 data-flex-basis=426px></p><p>While the upsampling stages are not structured like this exactly, the concept is similar in that we do a relatively small amount of work in a pass. Then this work gets reused again in the next pass, and we do the same thing again spreading things around more but just at a different resolution.</p><p><img src=/p/adventures-global-illumination-downscaling/content/graphic-upsampling-intro.png width=1920 height=1080 srcset="/p/adventures-global-illumination-downscaling/content/graphic-upsampling-intro_hu_56db27f2db7ba42.png 480w, /p/adventures-global-illumination-downscaling/content/graphic-upsampling-intro_hu_937cc100aa9b75bc.png 1024w" loading=lazy alt=graphic-upsampling-intro class=gallery-image data-flex-grow=177 data-flex-basis=426px></p><p>Also, because we are operating on a different resolution this affects our scale since we are working per pixel/texel <em>(Lower resolution means we effectively spread pixels around at a larger scale, higher resolution means we spread pixels around at a smaller scale)</em>.</p><p>Versus just 1 singular pass where we have to span across many pixel regions in order to get the same result, doing potentially thousands or more samples per pixel to achieve the same result, just like with the single pass blur example.</p><p>Each upsample pass/stage is essentially split by a power of two.</p><ul><li>Full Target Screen Resolution <em>(No Upsample Passes)</em></li><li>1/2th Target Screen Resolution <em>(1 Upsample Pass)</em></li><li>1/4th Target Screen Resolution <em>(2 Upsample Passes)</em></li><li>1/8th Target Screen Resolution <em>(3 Upsample Passes)</em></li><li>1/16th Target Screen Resolution <em>(4 Upsample Passes)</em></li><li>1/32th Target Screen Resolution <em>(5 Upsample Passes)</em></li></ul><p>In practice for 1/4th Resolution&mldr;</p><ol><li><em>(Inital Effect)</em> Calculate effect at 1/4th resolution</li><li><em>(Upsample Stage 1)</em> Upsample from 1/4th -> 1/2th</li><li><em>(Upsample Stage 2)</em> Upsample from 1/2th -> Full Resolution</li></ol><p>All upsampling related segments utilize this chaining process going forward.</p><p><img src=/p/adventures-global-illumination-downscaling/content/graphic-buffer-upsampling-pipeline.png width=1653 height=692 srcset="/p/adventures-global-illumination-downscaling/content/graphic-buffer-upsampling-pipeline_hu_fb429c4aee321c7f.png 480w, /p/adventures-global-illumination-downscaling/content/graphic-buffer-upsampling-pipeline_hu_23b0e19dc3526b25.png 1024w" loading=lazy alt=graphic-buffer-upsampling-pipeline class=gallery-image data-flex-grow=238 data-flex-basis=573px></p><p>Now lets explore what I did in regards to how I spread those pixels around&mldr;</p><h3 id=upsampling---the-basics-point-bilinear><a href=#upsampling---the-basics-point-bilinear class=header-anchor></a>Upsampling - The Basics (Point, Bilinear)</h3><p>The most basic-basic upsampling we can do is just to duplicate/copy the original pixel we have into the neighboring regions <em>(via Point Filtering)</em>.</p><p><img src=/p/adventures-global-illumination-downscaling/content/vct-4th-point-raw.png width=1201 height=713 srcset="/p/adventures-global-illumination-downscaling/content/vct-4th-point-raw_hu_4beee7171e24ce08.png 480w, /p/adventures-global-illumination-downscaling/content/vct-4th-point-raw_hu_40235cc71476ad63.png 1024w" loading=lazy alt=vct-4th-point-raw class=gallery-image data-flex-grow=168 data-flex-basis=404px>
<em>1/4th Resolution (2 upsample passes)</em></p><p>We can see this does not look good at all for what we ultimately want to achieve. Point filtering just simply copies the data we have into more regions, but it does not look good here.</p><p>We get visible blocking and pixelation, and the colors themselves are not properly aligned with the scene like it is with full resolution.</p><p>This can be improved by using bilinear filtering which will gradually &ldquo;fade&rdquo; between one pixel, and the next within a 2x2 pixel region.</p><p><img src=/p/adventures-global-illumination-downscaling/content/vct-4th-bilinear-raw.png width=1201 height=713 srcset="/p/adventures-global-illumination-downscaling/content/vct-4th-bilinear-raw_hu_4b0599d449d7ca50.png 480w, /p/adventures-global-illumination-downscaling/content/vct-4th-bilinear-raw_hu_7ef1910190f9d23e.png 1024w" loading=lazy alt=vct-4th-bilinear-raw class=gallery-image data-flex-grow=168 data-flex-basis=404px>
<em>1/4th Resolution (2 upsample passes)</em></p><p>It&rsquo;s an improvement&mldr; It&rsquo;s certianly more desirable than the point filtering, but the blockiness is still very visible. Additionally the colors themselves are not properly aligned with the scene like it was with full resolution.</p><p>Bilinear filtering does help <em>(and the cost is essentially free, virtually all modern hardware now supports it)</em> but obviously it&rsquo;s not enough&mldr;</p><p>We need to cover a wider pixel region!</p><h3 id=upsampling---wider-blur-filters><a href=#upsampling---wider-blur-filters class=header-anchor></a>Upsampling - Wider Blur Filters</h3><p><img src=/p/adventures-global-illumination-downscaling/content/vct-4th-gaussian9.png width=1201 height=713 srcset="/p/adventures-global-illumination-downscaling/content/vct-4th-gaussian9_hu_cad03b5ca0013a49.png 480w, /p/adventures-global-illumination-downscaling/content/vct-4th-gaussian9_hu_4eb17c363ca6ca01.png 1024w" loading=lazy alt=vct-4th-gaussian9 class=gallery-image data-flex-grow=168 data-flex-basis=404px>
<em>1/4th Resolution (2 upsample passes)</em></p><p>Here I am showing off a 9-tap single-pass gaussian blur.</p><p>We can see that now the underlying effect is much smoother compared to bilinear filtering. The pixelation artifacts and blockiness are much less visible now. Awesome!</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-HLSL data-lang=HLSL><span class=line><span class=cl><span class=kt>float4</span> <span class=n>UpsampleGaussian9Tap</span><span class=p>(</span><span class=kt>float2</span> <span class=n>uv</span><span class=p>,</span> <span class=kt>float2</span> <span class=n>texelSize</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>uvOffset</span> <span class=o>=</span> <span class=n>texelSize</span><span class=p>.</span><span class=n>xyxy</span> <span class=o>*</span> <span class=kt>float4</span><span class=p>(</span><span class=mf>1.0f</span><span class=p>,</span> <span class=mf>1.0f</span><span class=p>,</span> <span class=o>-</span><span class=mf>1.0f</span><span class=p>,</span> <span class=mf>0.0f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>half4</span> <span class=n>color</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv</span> <span class=o>-</span> <span class=n>uvOffset</span><span class=p>.</span><span class=n>xy</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>color</span> <span class=o>+=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv</span> <span class=o>-</span> <span class=n>uvOffset</span><span class=p>.</span><span class=n>wy</span><span class=p>)</span> <span class=o>*</span> <span class=mf>2.0f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>color</span> <span class=o>+=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv</span> <span class=o>-</span> <span class=n>uvOffset</span><span class=p>.</span><span class=n>zy</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>color</span> <span class=o>+=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv</span> <span class=o>+</span> <span class=n>uvOffset</span><span class=p>.</span><span class=n>zw</span><span class=p>)</span> <span class=o>*</span> <span class=mf>2.0f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>color</span> <span class=o>+=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv</span><span class=p>)</span> <span class=o>*</span> <span class=mf>4.0f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>color</span> <span class=o>+=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv</span> <span class=o>+</span> <span class=n>uvOffset</span><span class=p>.</span><span class=n>xw</span><span class=p>)</span> <span class=o>*</span> <span class=mf>2.0f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>color</span> <span class=o>+=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv</span> <span class=o>+</span> <span class=n>uvOffset</span><span class=p>.</span><span class=n>zy</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>color</span> <span class=o>+=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv</span> <span class=o>+</span> <span class=n>uvOffset</span><span class=p>.</span><span class=n>wy</span><span class=p>)</span> <span class=o>*</span> <span class=mf>2.0f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>color</span> <span class=o>+=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv</span> <span class=o>+</span> <span class=n>uvOffset</span><span class=p>.</span><span class=n>xy</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>color</span> <span class=o>*</span> <span class=mf>0.0625f</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>I am using a 9-tap single-pass gaussian blur. Not multi-pass, just single pass but at a very small radius. You could use different variants like a box filter, or a smaller kernel like a 5-tap or a 7-tap hexagonal.</p><p>But of course while we did mitigate most of the pixelation/blockiness, we still are left with the other problem with doing things at low resolution.</p><p><strong>That being that piels do not align with the underlying scene well at all.</strong> The wider filtering we are doing here just looks like a wierd bloom or blur effect. None of the details of the scene are preserved and it will only get worse with lower and lower resolutions.</p><p><img src=/p/adventures-global-illumination-downscaling/content/vct-8th-gaussian9.png width=1201 height=713 srcset="/p/adventures-global-illumination-downscaling/content/vct-8th-gaussian9_hu_8b6226406a783df3.png 480w, /p/adventures-global-illumination-downscaling/content/vct-8th-gaussian9_hu_ddf0c42ecd1405fc.png 1024w" loading=lazy alt=vct-8th-gaussian9 class=gallery-image data-flex-grow=168 data-flex-basis=404px>
<em>1/8th Resolution (3 upsample passes)</em></p><p>We need to somehow more intelligently determine what spots will recieve more blur, and what spots will try to remain sharp.</p><p>So how can we do this?</p><h3 id=upsampling---depth-aware><a href=#upsampling---depth-aware class=header-anchor></a>Upsampling - Depth Aware</h3><p>Enter depth upsampling.</p><p>We build on the idea before where we need to spread our pixel across to more areas than just that 2x2 block. This fixes the pixelation/aliasing problems, <strong>but we need to be smarter as to how to spread those pixels around.</strong></p><p>Fortunately, due to the nature of this effect <em>(Diffuse Global Illumination)</em> we already have access to a depth buffer which we used initally to calculate lighting for the visible surfaces in the scene.</p><p><img src=/p/adventures-global-illumination-downscaling/content/full-res-depth.png width=1201 height=713 srcset="/p/adventures-global-illumination-downscaling/content/full-res-depth_hu_dc6356cd414debee.png 480w, /p/adventures-global-illumination-downscaling/content/full-res-depth_hu_9fb54506a1be4852.png 1024w" loading=lazy alt=full-res-depth class=gallery-image data-flex-grow=168 data-flex-basis=404px>
<em>Raw Scene Depth</em></p><p>The depth buffer essentially tells us where surfaces are in the scene. Let&rsquo;s reuse it here to guide our upsampling filter!</p><p>Using the depth buffer we can determine roughly where there are continous smooth/flat surfaces, or if there are large gaps/discontinuities.</p><p><img src=/p/adventures-global-illumination-downscaling/content/graphic-depth-compare.png width=1920 height=1080 srcset="/p/adventures-global-illumination-downscaling/content/graphic-depth-compare_hu_cfdcc02e9c7e8de3.png 480w, /p/adventures-global-illumination-downscaling/content/graphic-depth-compare_hu_2e8ba6121157d710.png 1024w" loading=lazy alt=graphic-depth-compare class=gallery-image data-flex-grow=177 data-flex-basis=426px></p><p>The left side is zoomed into a pixel region of the depth buffer where we can see that alot of the pixels here are roughly the same. So when we compute the depth differences between the pixels in this region, it will be small or the same. This means that we should spread pixels around here more easily.</p><p>The right side is zoomed into a pixel region of the depth buffer where we can see that there a lot of differences and discontinuity. So when we compute the depth differences between the pixels in this region, it will be large. This means that we should NOT spread pixels around here that easily.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-HLSL data-lang=HLSL><span class=line><span class=cl><span class=kt>float4</span> <span class=n>UpsampleGaussian9TapDepthAware</span><span class=p>(</span><span class=kt>float2</span> <span class=n>uv</span><span class=p>,</span> <span class=kt>float2</span> <span class=n>texelSize</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>highResDepth</span> <span class=o>=</span> <span class=n>HighResDepthSample</span><span class=p>(</span><span class=n>uv</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>uv0</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span><span class=o>-</span><span class=n>texelSize</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=o>-</span><span class=n>texelSize</span><span class=p>.</span><span class=n>y</span><span class=p>);</span> <span class=c1>//top left</span>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>uv1</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span> <span class=mf>0.0</span><span class=p>,</span>         <span class=o>-</span><span class=n>texelSize</span><span class=p>.</span><span class=n>y</span><span class=p>);</span> <span class=c1>//top</span>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>uv2</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span> <span class=n>texelSize</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=o>-</span><span class=n>texelSize</span><span class=p>.</span><span class=n>y</span><span class=p>);</span> <span class=c1>//top right</span>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>uv3</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span><span class=o>-</span><span class=n>texelSize</span><span class=p>.</span><span class=n>x</span><span class=p>,</span>          <span class=mf>0.0</span><span class=p>);</span> <span class=c1>//left</span>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>uv5</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span> <span class=n>texelSize</span><span class=p>.</span><span class=n>x</span><span class=p>,</span>          <span class=mf>0.0</span><span class=p>);</span> <span class=c1>//right</span>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>uv6</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span><span class=o>-</span><span class=n>texelSize</span><span class=p>.</span><span class=n>x</span><span class=p>,</span>  <span class=n>texelSize</span><span class=p>.</span><span class=n>y</span><span class=p>);</span> <span class=c1>//bottom left</span>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>uv7</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span> <span class=mf>0.0</span><span class=p>,</span>          <span class=n>texelSize</span><span class=p>.</span><span class=n>y</span><span class=p>);</span> <span class=c1>//bottom</span>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>uv8</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span> <span class=n>texelSize</span><span class=p>.</span><span class=n>x</span><span class=p>,</span>  <span class=n>texelSize</span><span class=p>.</span><span class=n>y</span><span class=p>);</span> <span class=c1>//bottom right</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth0</span> <span class=o>=</span> <span class=n>LowResDepthSample</span><span class=p>(</span><span class=n>uv0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth1</span> <span class=o>=</span> <span class=n>LowResDepthSample</span><span class=p>(</span><span class=n>uv1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth2</span> <span class=o>=</span> <span class=n>LowResDepthSample</span><span class=p>(</span><span class=n>uv2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth3</span> <span class=o>=</span> <span class=n>LowResDepthSample</span><span class=p>(</span><span class=n>uv3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth4</span> <span class=o>=</span> <span class=n>LowResDepthSample</span><span class=p>(</span><span class=n>uv</span><span class=p>);</span> <span class=c1>//center</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth5</span> <span class=o>=</span> <span class=n>LowResDepthSample</span><span class=p>(</span><span class=n>uv5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth6</span> <span class=o>=</span> <span class=n>LowResDepthSample</span><span class=p>(</span><span class=n>uv6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth7</span> <span class=o>=</span> <span class=n>LowResDepthSample</span><span class=p>(</span><span class=n>uv7</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth8</span> <span class=o>=</span> <span class=n>LowResDepthSample</span><span class=p>(</span><span class=n>uv8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight0</span> <span class=o>=</span>       <span class=p>(</span><span class=mf>1.0</span> <span class=o>/</span> <span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth0</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight1</span> <span class=o>=</span> <span class=mf>2.0</span> <span class=o>*</span> <span class=p>(</span><span class=mf>1.0</span> <span class=o>/</span> <span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth1</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight2</span> <span class=o>=</span>       <span class=p>(</span><span class=mf>1.0</span> <span class=o>/</span> <span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth2</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight3</span> <span class=o>=</span> <span class=mf>2.0</span> <span class=o>*</span> <span class=p>(</span><span class=mf>1.0</span> <span class=o>/</span> <span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth3</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight4</span> <span class=o>=</span> <span class=mf>4.0</span> <span class=o>*</span> <span class=p>(</span><span class=mf>1.0</span> <span class=o>/</span> <span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth4</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>));</span> <span class=c1>//center</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight5</span> <span class=o>=</span> <span class=mf>2.0</span> <span class=o>*</span> <span class=p>(</span><span class=mf>1.0</span> <span class=o>/</span> <span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth5</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight6</span> <span class=o>=</span>       <span class=p>(</span><span class=mf>1.0</span> <span class=o>/</span> <span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth6</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight7</span> <span class=o>=</span> <span class=mf>2.0</span> <span class=o>*</span> <span class=p>(</span><span class=mf>1.0</span> <span class=o>/</span> <span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth7</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight8</span> <span class=o>=</span>       <span class=p>(</span><span class=mf>1.0</span> <span class=o>/</span> <span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth8</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color0</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color1</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color2</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color3</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color4</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv</span><span class=p>);</span> <span class=c1>//center</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color5</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color6</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color7</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv7</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color8</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>        <span class=n>color0</span> <span class=o>*</span> <span class=n>depthWeight0</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>color1</span> <span class=o>*</span> <span class=n>depthWeight1</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>color2</span> <span class=o>*</span> <span class=n>depthWeight2</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>color3</span> <span class=o>*</span> <span class=n>depthWeight3</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>color4</span> <span class=o>*</span> <span class=n>depthWeight4</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>color5</span> <span class=o>*</span> <span class=n>depthWeight5</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>color6</span> <span class=o>*</span> <span class=n>depthWeight6</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>color7</span> <span class=o>*</span> <span class=n>depthWeight7</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>color8</span> <span class=o>*</span> <span class=n>depthWeight8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>totalWeight</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>        <span class=n>depthWeight0</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>depthWeight1</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>depthWeight2</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>depthWeight3</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>depthWeight4</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>depthWeight5</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>depthWeight6</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>depthWeight7</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>depthWeight8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>color</span> <span class=o>/</span> <span class=nb>max</span><span class=p>(</span><span class=n>totalWeight</span><span class=p>,</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>6</span><span class=p>);</span> <span class=c1>//avoid divide by zero with max</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>By using Depth upsampling here and weighting (multiplying) each of our taps based on how the depth changes, we can see how this affects our blur filter now&mldr;</p><p><img src=/p/adventures-global-illumination-downscaling/content/vct-4th-depth.png width=1199 height=713 srcset="/p/adventures-global-illumination-downscaling/content/vct-4th-depth_hu_d9bd97cbfa800286.png 480w, /p/adventures-global-illumination-downscaling/content/vct-4th-depth_hu_18e80ff04d9687d7.png 1024w" loading=lazy alt=vct-4th-depth class=gallery-image data-flex-grow=168 data-flex-basis=403px>
<em>1/4th Resolution (2 upsample passes)</em></p><p>We can actually see some of original sharp edges of some of the objects in the scene coming back now!</p><p>For some effects like volumetric fog, or mabye even SSAO, this is usually where your work would end.</p><p>But with something as complicated as calulating diffuse global illumination however, I discovered that this still wasn&rsquo;t quite convincing enough for me <em>(and mabye even for you)</em>.</p><p>The quality is certainly better than it was, but there were still large portions of the scene here where surfaces that originally had plenty of detail now get smeared over when we compare with the original expensive full resolution buffer.</p><p><img src=/p/adventures-global-illumination-downscaling/content/vct-full-res.png width=1201 height=713 srcset="/p/adventures-global-illumination-downscaling/content/vct-full-res_hu_297d2d9ae0582ae6.png 480w, /p/adventures-global-illumination-downscaling/content/vct-full-res_hu_7a9f970a90468457.png 1024w" loading=lazy alt=vct-full-res class=gallery-image data-flex-grow=168 data-flex-basis=404px>
<em>Full Resolution (0 upsample passes)</em></p><p>So using depth helps, but it looks like we need more information about the scene in order to better spread our pixels around. Is there another attribute aside from just depth that we can utlize to help align/place pixels even more?</p><h3 id=upsampling---depth-and-normal-aware><a href=#upsampling---depth-and-normal-aware class=header-anchor></a>Upsampling - Depth and Normal Aware</h3><p>Enter depth-normal upsampling.</p><p>Once again we build on the idea before with depth aware upsampling. Now we add an additional attribute, so along with using the scene depth buffer, we will also use scene normal buffer to help more with retaining the edges of objects and even some normal mapped details.</p><p>Just like the depth buffer, we also used the normal buffer in our inital lighting calculations to find the orientation of a surface and calculate the lighting of that point. Lets reuse it again here to guide our upsample filtering.</p><p><img src=/p/adventures-global-illumination-downscaling/content/full-res-normal.png width=1199 height=713 srcset="/p/adventures-global-illumination-downscaling/content/full-res-normal_hu_3ac0b3e13ccc9150.png 480w, /p/adventures-global-illumination-downscaling/content/full-res-normal_hu_41bcc57ce78e1ca4.png 1024w" loading=lazy alt=full-res-normal class=gallery-image data-flex-grow=168 data-flex-basis=403px>
<em>Scene Normals ([0..1] range)</em></p><p>Normals tell us the orientation of surfaces in a scene.</p><p><img src=/p/adventures-global-illumination-downscaling/content/graphic-normal-compare.png width=1920 height=1080 srcset="/p/adventures-global-illumination-downscaling/content/graphic-normal-compare_hu_ebd9bf86ba0dc5c9.png 480w, /p/adventures-global-illumination-downscaling/content/graphic-normal-compare_hu_195f33e9d286c264.png 1024w" loading=lazy alt=graphic-normal-compare class=gallery-image data-flex-grow=177 data-flex-basis=426px></p><p>The left side is zoomed into a pixel region of the normal buffer where we can see that alot of the pixels here are roughly the same. So when we compute the normal differences between the pixels in this region, it will be small or the same. This means that we should spread pixels around here more easily.</p><p>The right side is zoomed into a pixel region of the normal buffer where we can see that there a lot of differences and discontinuity. So when we compute the normal differences between the pixels in this region, it will be large. This means that we should NOT spread pixels around here that easily.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-HLSL data-lang=HLSL><span class=line><span class=cl><span class=kt>float4</span> <span class=n>UpsampleSmooth_Gaussian9Tap_DepthNormalAwareInterpolated</span><span class=p>(</span><span class=kt>float2</span> <span class=n>uv</span><span class=p>,</span> <span class=kt>float2</span> <span class=n>texelSize</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>highResDepth</span> <span class=o>=</span> <span class=n>HighResDepthSample</span><span class=p>(</span><span class=n>uv</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float3</span> <span class=n>highResNormal</span> <span class=o>=</span> <span class=n>HighResNormalSample</span><span class=p>(</span><span class=n>uv</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>uv0</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span><span class=o>-</span><span class=n>texelSize</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=o>-</span><span class=n>texelSize</span><span class=p>.</span><span class=n>y</span><span class=p>);</span> <span class=c1>//top left</span>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>uv1</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span> <span class=mf>0.0</span><span class=p>,</span>         <span class=o>-</span><span class=n>texelSize</span><span class=p>.</span><span class=n>y</span><span class=p>);</span> <span class=c1>//top</span>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>uv2</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span> <span class=n>texelSize</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=o>-</span><span class=n>texelSize</span><span class=p>.</span><span class=n>y</span><span class=p>);</span> <span class=c1>//top right</span>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>uv3</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span><span class=o>-</span><span class=n>texelSize</span><span class=p>.</span><span class=n>x</span><span class=p>,</span>          <span class=mf>0.0</span><span class=p>);</span> <span class=c1>//left</span>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>uv5</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span> <span class=n>texelSize</span><span class=p>.</span><span class=n>x</span><span class=p>,</span>          <span class=mf>0.0</span><span class=p>);</span> <span class=c1>//right</span>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>uv6</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span><span class=o>-</span><span class=n>texelSize</span><span class=p>.</span><span class=n>x</span><span class=p>,</span>  <span class=n>texelSize</span><span class=p>.</span><span class=n>y</span><span class=p>);</span> <span class=c1>//bottom left</span>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>uv7</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span> <span class=mf>0.0</span><span class=p>,</span>          <span class=n>texelSize</span><span class=p>.</span><span class=n>y</span><span class=p>);</span> <span class=c1>//bottom</span>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>uv8</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span> <span class=n>texelSize</span><span class=p>.</span><span class=n>x</span><span class=p>,</span>  <span class=n>texelSize</span><span class=p>.</span><span class=n>y</span><span class=p>);</span> <span class=c1>//bottom right</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth0</span> <span class=o>=</span> <span class=n>LowResDepthSample</span><span class=p>(</span><span class=n>uv0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth1</span> <span class=o>=</span> <span class=n>LowResDepthSample</span><span class=p>(</span><span class=n>uv1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth2</span> <span class=o>=</span> <span class=n>LowResDepthSample</span><span class=p>(</span><span class=n>uv2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth3</span> <span class=o>=</span> <span class=n>LowResDepthSample</span><span class=p>(</span><span class=n>uv3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth4</span> <span class=o>=</span> <span class=n>LowResDepthSample</span><span class=p>(</span><span class=n>uv</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth5</span> <span class=o>=</span> <span class=n>LowResDepthSample</span><span class=p>(</span><span class=n>uv5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth6</span> <span class=o>=</span> <span class=n>LowResDepthSample</span><span class=p>(</span><span class=n>uv6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth7</span> <span class=o>=</span> <span class=n>LowResDepthSample</span><span class=p>(</span><span class=n>uv7</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth8</span> <span class=o>=</span> <span class=n>LowResDepthSample</span><span class=p>(</span><span class=n>uv8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>float3</span> <span class=n>lowResNormal0</span> <span class=o>=</span> <span class=n>LowResNormalSample</span><span class=p>(</span><span class=n>uv0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float3</span> <span class=n>lowResNormal1</span> <span class=o>=</span> <span class=n>LowResNormalSample</span><span class=p>(</span><span class=n>uv1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float3</span> <span class=n>lowResNormal2</span> <span class=o>=</span> <span class=n>LowResNormalSample</span><span class=p>(</span><span class=n>uv2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float3</span> <span class=n>lowResNormal3</span> <span class=o>=</span> <span class=n>LowResNormalSample</span><span class=p>(</span><span class=n>uv3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float3</span> <span class=n>lowResNormal4</span> <span class=o>=</span> <span class=n>LowResNormalSample</span><span class=p>(</span><span class=n>uv</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float3</span> <span class=n>lowResNormal5</span> <span class=o>=</span> <span class=n>LowResNormalSample</span><span class=p>(</span><span class=n>uv5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float3</span> <span class=n>lowResNormal6</span> <span class=o>=</span> <span class=n>LowResNormalSample</span><span class=p>(</span><span class=n>uv6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float3</span> <span class=n>lowResNormal7</span> <span class=o>=</span> <span class=n>LowResNormalSample</span><span class=p>(</span><span class=n>uv7</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float3</span> <span class=n>lowResNormal8</span> <span class=o>=</span> <span class=n>LowResNormalSample</span><span class=p>(</span><span class=n>uv8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight0</span> <span class=o>=</span>       <span class=p>(</span><span class=mf>1.0</span> <span class=o>/</span> <span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth0</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight1</span> <span class=o>=</span> <span class=mf>2.0</span> <span class=o>*</span> <span class=p>(</span><span class=mf>1.0</span> <span class=o>/</span> <span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth1</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight2</span> <span class=o>=</span>       <span class=p>(</span><span class=mf>1.0</span> <span class=o>/</span> <span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth2</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight3</span> <span class=o>=</span> <span class=mf>2.0</span> <span class=o>*</span> <span class=p>(</span><span class=mf>1.0</span> <span class=o>/</span> <span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth3</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight4</span> <span class=o>=</span> <span class=mf>4.0</span> <span class=o>*</span> <span class=p>(</span><span class=mf>1.0</span> <span class=o>/</span> <span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth4</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight5</span> <span class=o>=</span> <span class=mf>2.0</span> <span class=o>*</span> <span class=p>(</span><span class=mf>1.0</span> <span class=o>/</span> <span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth5</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight6</span> <span class=o>=</span>       <span class=p>(</span><span class=mf>1.0</span> <span class=o>/</span> <span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth6</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight7</span> <span class=o>=</span> <span class=mf>2.0</span> <span class=o>*</span> <span class=p>(</span><span class=mf>1.0</span> <span class=o>/</span> <span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth7</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight8</span> <span class=o>=</span>       <span class=p>(</span><span class=mf>1.0</span> <span class=o>/</span> <span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth8</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//NOTE: this might be able to be approximated or simplified some more</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>normalPower</span> <span class=o>=</span> <span class=mf>10.0f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>normalWeight0</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=nb>saturate</span><span class=p>(</span><span class=nb>dot</span><span class=p>(</span><span class=n>highResNormal</span><span class=p>,</span> <span class=n>lowResNormal0</span><span class=p>)),</span> <span class=n>normalPower</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>normalWeight1</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=nb>saturate</span><span class=p>(</span><span class=nb>dot</span><span class=p>(</span><span class=n>highResNormal</span><span class=p>,</span> <span class=n>lowResNormal1</span><span class=p>)),</span> <span class=n>normalPower</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>normalWeight2</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=nb>saturate</span><span class=p>(</span><span class=nb>dot</span><span class=p>(</span><span class=n>highResNormal</span><span class=p>,</span> <span class=n>lowResNormal2</span><span class=p>)),</span> <span class=n>normalPower</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>normalWeight3</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=nb>saturate</span><span class=p>(</span><span class=nb>dot</span><span class=p>(</span><span class=n>highResNormal</span><span class=p>,</span> <span class=n>lowResNormal3</span><span class=p>)),</span> <span class=n>normalPower</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>normalWeight4</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=nb>saturate</span><span class=p>(</span><span class=nb>dot</span><span class=p>(</span><span class=n>highResNormal</span><span class=p>,</span> <span class=n>lowResNormal4</span><span class=p>)),</span> <span class=n>normalPower</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>normalWeight5</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=nb>saturate</span><span class=p>(</span><span class=nb>dot</span><span class=p>(</span><span class=n>highResNormal</span><span class=p>,</span> <span class=n>lowResNormal5</span><span class=p>)),</span> <span class=n>normalPower</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>normalWeight6</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=nb>saturate</span><span class=p>(</span><span class=nb>dot</span><span class=p>(</span><span class=n>highResNormal</span><span class=p>,</span> <span class=n>lowResNormal6</span><span class=p>)),</span> <span class=n>normalPower</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>normalWeight7</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=nb>saturate</span><span class=p>(</span><span class=nb>dot</span><span class=p>(</span><span class=n>highResNormal</span><span class=p>,</span> <span class=n>lowResNormal7</span><span class=p>)),</span> <span class=n>normalPower</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>normalWeight8</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=nb>saturate</span><span class=p>(</span><span class=nb>dot</span><span class=p>(</span><span class=n>highResNormal</span><span class=p>,</span> <span class=n>lowResNormal8</span><span class=p>)),</span> <span class=n>normalPower</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color0</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color1</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color2</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color3</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color4</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color5</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color6</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color7</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv7</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color8</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//combined weights</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>w0</span> <span class=o>=</span> <span class=n>depthWeight0</span> <span class=o>*</span> <span class=n>normalWeight0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>w1</span> <span class=o>=</span> <span class=n>depthWeight1</span> <span class=o>*</span> <span class=n>normalWeight1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>w2</span> <span class=o>=</span> <span class=n>depthWeight2</span> <span class=o>*</span> <span class=n>normalWeight2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>w3</span> <span class=o>=</span> <span class=n>depthWeight3</span> <span class=o>*</span> <span class=n>normalWeight3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>w4</span> <span class=o>=</span> <span class=n>depthWeight4</span> <span class=o>*</span> <span class=n>normalWeight4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>w5</span> <span class=o>=</span> <span class=n>depthWeight5</span> <span class=o>*</span> <span class=n>normalWeight5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>w6</span> <span class=o>=</span> <span class=n>depthWeight6</span> <span class=o>*</span> <span class=n>normalWeight6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>w7</span> <span class=o>=</span> <span class=n>depthWeight7</span> <span class=o>*</span> <span class=n>normalWeight7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>w8</span> <span class=o>=</span> <span class=n>depthWeight8</span> <span class=o>*</span> <span class=n>normalWeight8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//weighted accumulation</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>color0</span> <span class=o>*</span> <span class=n>w0</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>color1</span> <span class=o>*</span> <span class=n>w1</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>color2</span> <span class=o>*</span> <span class=n>w2</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>color3</span> <span class=o>*</span> <span class=n>w3</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>color4</span> <span class=o>*</span> <span class=n>w4</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>color5</span> <span class=o>*</span> <span class=n>w5</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>color6</span> <span class=o>*</span> <span class=n>w6</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>color7</span> <span class=o>*</span> <span class=n>w7</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>color8</span> <span class=o>*</span> <span class=n>w8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>totalWeight</span> <span class=o>=</span> <span class=n>w0</span> <span class=o>+</span> <span class=n>w1</span> <span class=o>+</span> <span class=n>w2</span> <span class=o>+</span> <span class=n>w3</span> <span class=o>+</span> <span class=n>w4</span> <span class=o>+</span> <span class=n>w5</span> <span class=o>+</span> <span class=n>w6</span> <span class=o>+</span> <span class=n>w7</span> <span class=o>+</span> <span class=n>w8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>color</span> <span class=o>/=</span> <span class=nb>max</span><span class=p>(</span><span class=n>totalWeight</span><span class=p>,</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>color</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Implementing it very similarly here with the depth, we just do 9 taps <em>(or whatever amount your underlying filter is doing)</em> with normal, then calculate the deviations that happen between the pixel regions and we weigh these with our depth.</p><p><img src=/p/adventures-global-illumination-downscaling/content/vct-4th-depthnormal.png width=1199 height=713 srcset="/p/adventures-global-illumination-downscaling/content/vct-4th-depthnormal_hu_63681ae2d9956377.png 480w, /p/adventures-global-illumination-downscaling/content/vct-4th-depthnormal_hu_7eedcd5bfaf2dc8c.png 1024w" loading=lazy alt=vct-4th-depthnormal class=gallery-image data-flex-grow=168 data-flex-basis=403px>
<em>1/4th Resolution (2 upsample passes)</em></p><p>Nice! We can see now that this is a significant improvement over just depth-aware upsampling. Geometry edges are almost fully preserved now, and much less pixelation artifacts are visible at the same time.</p><p>In fact this gives me enough confidence in that I might push things further by dropping the resolution to 1/8th and see how things hold up.</p><p><img src=/p/adventures-global-illumination-downscaling/content/vct-8th-depthnormal.png width=1199 height=713 srcset="/p/adventures-global-illumination-downscaling/content/vct-8th-depthnormal_hu_13a4e880524c2d4.png 480w, /p/adventures-global-illumination-downscaling/content/vct-8th-depthnormal_hu_765ea19176eef8de.png 1024w" loading=lazy alt=vct-8th-depthnormal class=gallery-image data-flex-grow=168 data-flex-basis=403px>
<em>1/8th Resolution (3 upsample passes)</em></p><p>Surpisingly well, some pixelation is more visible now of course but the depth-normal aware upsampling is doing a fantastic job of keeping all of the geometry edges and some of the normals sharp and visible.</p><p>But even then&mldr; there are still some things that irk me even at 1/4th resolution, and the issues get more visible when dropping down to 1/8th now. Geometry edges are kept in-tact but most of the original normal-mapped material details of the scene are mostly gone now. Pixelation details also are starting to become even more visible.</p><p>Is there a way to hide those pixelation artifacts some more, and mabye even bring back normal-mapped details?</p><p><em>Spoiler: Yes!</em></p><h4 id=optimization-bonus><a href=#optimization-bonus class=header-anchor></a>Optimization Bonus</h4><p>Now I would like to point out here that depending on your setup this depth-normal upsampling will cost an extra render target, which means more texture lookups to factor in this normal buffer read like you see in this implementation.</p><p>An additional optimization here that you can that is to pack a singluar float4 render target with both depth <em>(16-bit half precision)</em> and normal <em>(encoded into a 2 channel using octahedron/spherical coordinates/etc).</em></p><ul><li>RG: Depth (Half Precsion 16-bit)</li><li>BA: Normal (Encoded into 2 component 16-bit)</li></ul><p>This would reduce the texture fetches, at the expense of adding additional instructions for unpacking the render target for use in the filter. <em>(You are basically trading memory for ALU here. Fortunately with most modern hardware now being more capable, this is prefered so that way you are not bound by memory access speeds with texture reads)</em>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-HLSL data-lang=HLSL><span class=line><span class=cl><span class=c1>//PUSEDO CODE</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>UnpackDepthNormalTarget</span><span class=p>(</span><span class=k>in</span> <span class=kt>float4</span> <span class=n>depthNormal</span><span class=p>,</span> <span class=k>out</span> <span class=kt>float</span> <span class=n>depth</span><span class=p>,</span> <span class=k>out</span> <span class=kt>float3</span> <span class=n>normal</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//take &#39;depthNormal&#39; which should be RGBA32 (or RGBA64 if you want more precision)</span>
</span></span><span class=line><span class=cl>    <span class=c1>//RG: 16 bits half precision depth</span>
</span></span><span class=line><span class=cl>    <span class=c1>//BA: 16 bits encoded normal (normal can be encoded with spherical coordinates/octahedron)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//decode and output depth...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//decode and output normal...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-HLSL data-lang=HLSL><span class=line><span class=cl><span class=c1>//optimizations made</span>
</span></span><span class=line><span class=cl><span class=c1>// + texture fetches are reduced by 10 (19 now, compared to 29 before)</span>
</span></span><span class=line><span class=cl><span class=c1>//   achieved with a packed RGBA Depth Normal render target.</span>
</span></span><span class=line><span class=cl><span class=c1>//   trading for more ALU for unpacking instructions </span>
</span></span><span class=line><span class=cl><span class=c1>// + re-wrote normal weights and replaced pow with 4 mul&#39;s (hardcoded pow 4.0)</span>
</span></span><span class=line><span class=cl><span class=c1>// + re-wrote depth weights to use HLSL rcp()</span>
</span></span><span class=line><span class=cl><span class=kt>float4</span> <span class=n>UpsampleSmooth_Gaussian9Tap_DepthNormalAwareInterpolatedOptimized</span><span class=p>(</span><span class=kt>float2</span> <span class=n>uv</span><span class=p>,</span> <span class=kt>float2</span> <span class=n>texelSize</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>highResDepthNormal</span> <span class=o>=</span> <span class=n>HighResDepthNormalSample</span><span class=p>(</span><span class=n>uv</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>highResDepth</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float3</span> <span class=n>highResNormal</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>UnpackDepthNormalTarget</span><span class=p>(</span><span class=n>highResDepthNormal</span><span class=p>,</span> <span class=n>highResDepth</span><span class=p>,</span> <span class=n>highResNormal</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>uv0</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span><span class=o>-</span><span class=n>texelSize</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=o>-</span><span class=n>texelSize</span><span class=p>.</span><span class=n>y</span><span class=p>);</span> <span class=c1>//top left</span>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>uv1</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span> <span class=mf>0.0</span><span class=p>,</span>         <span class=o>-</span><span class=n>texelSize</span><span class=p>.</span><span class=n>y</span><span class=p>);</span> <span class=c1>//top</span>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>uv2</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span> <span class=n>texelSize</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=o>-</span><span class=n>texelSize</span><span class=p>.</span><span class=n>y</span><span class=p>);</span> <span class=c1>//top right</span>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>uv3</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span><span class=o>-</span><span class=n>texelSize</span><span class=p>.</span><span class=n>x</span><span class=p>,</span>          <span class=mf>0.0</span><span class=p>);</span> <span class=c1>//left</span>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>uv5</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span> <span class=n>texelSize</span><span class=p>.</span><span class=n>x</span><span class=p>,</span>          <span class=mf>0.0</span><span class=p>);</span> <span class=c1>//right</span>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>uv6</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span><span class=o>-</span><span class=n>texelSize</span><span class=p>.</span><span class=n>x</span><span class=p>,</span>  <span class=n>texelSize</span><span class=p>.</span><span class=n>y</span><span class=p>);</span> <span class=c1>//bottom left</span>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>uv7</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span> <span class=mf>0.0</span><span class=p>,</span>          <span class=n>texelSize</span><span class=p>.</span><span class=n>y</span><span class=p>);</span> <span class=c1>//bottom</span>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>uv8</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span> <span class=n>texelSize</span><span class=p>.</span><span class=n>x</span><span class=p>,</span>  <span class=n>texelSize</span><span class=p>.</span><span class=n>y</span><span class=p>);</span> <span class=c1>//bottom right</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>lowResDepthNormal0</span> <span class=o>=</span> <span class=n>LowResDepthNormalSample</span><span class=p>(</span><span class=n>uv0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>lowResDepthNormal1</span> <span class=o>=</span> <span class=n>LowResDepthNormalSample</span><span class=p>(</span><span class=n>uv1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>lowResDepthNormal2</span> <span class=o>=</span> <span class=n>LowResDepthNormalSample</span><span class=p>(</span><span class=n>uv2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>lowResDepthNormal3</span> <span class=o>=</span> <span class=n>LowResDepthNormalSample</span><span class=p>(</span><span class=n>uv3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>lowResDepthNormal4</span> <span class=o>=</span> <span class=n>LowResDepthNormalSample</span><span class=p>(</span><span class=n>uv</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>lowResDepthNormal5</span> <span class=o>=</span> <span class=n>LowResDepthNormalSample</span><span class=p>(</span><span class=n>uv5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>lowResDepthNormal6</span> <span class=o>=</span> <span class=n>LowResDepthNormalSample</span><span class=p>(</span><span class=n>uv6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>lowResDepthNormal7</span> <span class=o>=</span> <span class=n>LowResDepthNormalSample</span><span class=p>(</span><span class=n>uv7</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>lowResDepthNormal8</span> <span class=o>=</span> <span class=n>LowResDepthNormalSample</span><span class=p>(</span><span class=n>uv8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>lowResDepth8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>float3</span> <span class=n>lowResNormal0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float3</span> <span class=n>lowResNormal1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float3</span> <span class=n>lowResNormal2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float3</span> <span class=n>lowResNormal3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float3</span> <span class=n>lowResNormal4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float3</span> <span class=n>lowResNormal5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float3</span> <span class=n>lowResNormal6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float3</span> <span class=n>lowResNormal7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float3</span> <span class=n>lowResNormal8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>UnpackDepthNormalTarget</span><span class=p>(</span><span class=n>lowResDepthNormal0</span><span class=p>,</span> <span class=n>lowResDepth0</span><span class=p>,</span> <span class=n>lowResNormal0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>UnpackDepthNormalTarget</span><span class=p>(</span><span class=n>lowResDepthNormal1</span><span class=p>,</span> <span class=n>lowResDepth1</span><span class=p>,</span> <span class=n>lowResNormal1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>UnpackDepthNormalTarget</span><span class=p>(</span><span class=n>lowResDepthNormal2</span><span class=p>,</span> <span class=n>lowResDepth2</span><span class=p>,</span> <span class=n>lowResNormal2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>UnpackDepthNormalTarget</span><span class=p>(</span><span class=n>lowResDepthNormal3</span><span class=p>,</span> <span class=n>lowResDepth3</span><span class=p>,</span> <span class=n>lowResNormal3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>UnpackDepthNormalTarget</span><span class=p>(</span><span class=n>lowResDepthNormal4</span><span class=p>,</span> <span class=n>lowResDepth4</span><span class=p>,</span> <span class=n>lowResNormal4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>UnpackDepthNormalTarget</span><span class=p>(</span><span class=n>lowResDepthNormal5</span><span class=p>,</span> <span class=n>lowResDepth5</span><span class=p>,</span> <span class=n>lowResNormal5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>UnpackDepthNormalTarget</span><span class=p>(</span><span class=n>lowResDepthNormal6</span><span class=p>,</span> <span class=n>lowResDepth6</span><span class=p>,</span> <span class=n>lowResNormal6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>UnpackDepthNormalTarget</span><span class=p>(</span><span class=n>lowResDepthNormal7</span><span class=p>,</span> <span class=n>lowResDepth7</span><span class=p>,</span> <span class=n>lowResNormal7</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>UnpackDepthNormalTarget</span><span class=p>(</span><span class=n>lowResDepthNormal8</span><span class=p>,</span> <span class=n>lowResDepth8</span><span class=p>,</span> <span class=n>lowResNormal8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//replaced (1.0 / difference) with HLSL rcp()</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight0</span> <span class=o>=</span>       <span class=nb>rcp</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth0</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight1</span> <span class=o>=</span> <span class=mf>2.0</span> <span class=o>*</span> <span class=nb>rcp</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth1</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight2</span> <span class=o>=</span>       <span class=nb>rcp</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth2</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight3</span> <span class=o>=</span> <span class=mf>2.0</span> <span class=o>*</span> <span class=nb>rcp</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth3</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight4</span> <span class=o>=</span> <span class=mf>4.0</span> <span class=o>*</span> <span class=nb>rcp</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth4</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight5</span> <span class=o>=</span> <span class=mf>2.0</span> <span class=o>*</span> <span class=nb>rcp</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth5</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight6</span> <span class=o>=</span>       <span class=nb>rcp</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth6</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight7</span> <span class=o>=</span> <span class=mf>2.0</span> <span class=o>*</span> <span class=nb>rcp</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth7</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>depthWeight8</span> <span class=o>=</span>       <span class=nb>rcp</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>highResDepth</span> <span class=o>-</span> <span class=n>lowResDepth8</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//NOTE: this might be able to be approximated or simplified even more</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>normalWeight0</span> <span class=o>=</span> <span class=nb>saturate</span><span class=p>(</span><span class=nb>dot</span><span class=p>(</span><span class=n>highResNormal</span><span class=p>,</span> <span class=n>lowResNormal0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>normalWeight1</span> <span class=o>=</span> <span class=nb>saturate</span><span class=p>(</span><span class=nb>dot</span><span class=p>(</span><span class=n>highResNormal</span><span class=p>,</span> <span class=n>lowResNormal1</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>normalWeight2</span> <span class=o>=</span> <span class=nb>saturate</span><span class=p>(</span><span class=nb>dot</span><span class=p>(</span><span class=n>highResNormal</span><span class=p>,</span> <span class=n>lowResNormal2</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>normalWeight3</span> <span class=o>=</span> <span class=nb>saturate</span><span class=p>(</span><span class=nb>dot</span><span class=p>(</span><span class=n>highResNormal</span><span class=p>,</span> <span class=n>lowResNormal3</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>normalWeight4</span> <span class=o>=</span> <span class=nb>saturate</span><span class=p>(</span><span class=nb>dot</span><span class=p>(</span><span class=n>highResNormal</span><span class=p>,</span> <span class=n>lowResNormal4</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>normalWeight5</span> <span class=o>=</span> <span class=nb>saturate</span><span class=p>(</span><span class=nb>dot</span><span class=p>(</span><span class=n>highResNormal</span><span class=p>,</span> <span class=n>lowResNormal5</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>normalWeight6</span> <span class=o>=</span> <span class=nb>saturate</span><span class=p>(</span><span class=nb>dot</span><span class=p>(</span><span class=n>highResNormal</span><span class=p>,</span> <span class=n>lowResNormal6</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>normalWeight7</span> <span class=o>=</span> <span class=nb>saturate</span><span class=p>(</span><span class=nb>dot</span><span class=p>(</span><span class=n>highResNormal</span><span class=p>,</span> <span class=n>lowResNormal7</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>normalWeight8</span> <span class=o>=</span> <span class=nb>saturate</span><span class=p>(</span><span class=nb>dot</span><span class=p>(</span><span class=n>highResNormal</span><span class=p>,</span> <span class=n>lowResNormal8</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//NOTE: power has been reduced to 4, so the normal effect may not appear as strong but saves you from doing a pow op</span>
</span></span><span class=line><span class=cl>    <span class=c1>//you could just stack more mul&#39;s if you wanted a stronger effect</span>
</span></span><span class=line><span class=cl>    <span class=n>normalWeight0</span> <span class=o>*=</span> <span class=n>normalWeight0</span> <span class=o>*</span> <span class=n>normalWeight0</span> <span class=o>*</span> <span class=n>normalWeight0</span><span class=p>;</span> <span class=c1>//hardcoded pow 4.0</span>
</span></span><span class=line><span class=cl>    <span class=n>normalWeight1</span> <span class=o>*=</span> <span class=n>normalWeight1</span> <span class=o>*</span> <span class=n>normalWeight1</span> <span class=o>*</span> <span class=n>normalWeight1</span><span class=p>;</span> <span class=c1>//hardcoded pow 4.0</span>
</span></span><span class=line><span class=cl>    <span class=n>normalWeight2</span> <span class=o>*=</span> <span class=n>normalWeight2</span> <span class=o>*</span> <span class=n>normalWeight2</span> <span class=o>*</span> <span class=n>normalWeight2</span><span class=p>;</span> <span class=c1>//hardcoded pow 4.0</span>
</span></span><span class=line><span class=cl>    <span class=n>normalWeight3</span> <span class=o>*=</span> <span class=n>normalWeight3</span> <span class=o>*</span> <span class=n>normalWeight3</span> <span class=o>*</span> <span class=n>normalWeight3</span><span class=p>;</span> <span class=c1>//hardcoded pow 4.0</span>
</span></span><span class=line><span class=cl>    <span class=n>normalWeight4</span> <span class=o>*=</span> <span class=n>normalWeight4</span> <span class=o>*</span> <span class=n>normalWeight4</span> <span class=o>*</span> <span class=n>normalWeight4</span><span class=p>;</span> <span class=c1>//hardcoded pow 4.0</span>
</span></span><span class=line><span class=cl>    <span class=n>normalWeight5</span> <span class=o>*=</span> <span class=n>normalWeight5</span> <span class=o>*</span> <span class=n>normalWeight5</span> <span class=o>*</span> <span class=n>normalWeight5</span><span class=p>;</span> <span class=c1>//hardcoded pow 4.0</span>
</span></span><span class=line><span class=cl>    <span class=n>normalWeight6</span> <span class=o>*=</span> <span class=n>normalWeight6</span> <span class=o>*</span> <span class=n>normalWeight6</span> <span class=o>*</span> <span class=n>normalWeight6</span><span class=p>;</span> <span class=c1>//hardcoded pow 4.0</span>
</span></span><span class=line><span class=cl>    <span class=n>normalWeight7</span> <span class=o>*=</span> <span class=n>normalWeight7</span> <span class=o>*</span> <span class=n>normalWeight7</span> <span class=o>*</span> <span class=n>normalWeight7</span><span class=p>;</span> <span class=c1>//hardcoded pow 4.0</span>
</span></span><span class=line><span class=cl>    <span class=n>normalWeight8</span> <span class=o>*=</span> <span class=n>normalWeight8</span> <span class=o>*</span> <span class=n>normalWeight8</span> <span class=o>*</span> <span class=n>normalWeight8</span><span class=p>;</span> <span class=c1>//hardcoded pow 4.0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color0</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color1</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color2</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color3</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color4</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color5</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color6</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color7</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv7</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color8</span> <span class=o>=</span> <span class=n>LowResColorSample</span><span class=p>(</span><span class=n>uv8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//combined weights</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>w0</span> <span class=o>=</span> <span class=n>depthWeight0</span> <span class=o>*</span> <span class=n>normalWeight0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>w1</span> <span class=o>=</span> <span class=n>depthWeight1</span> <span class=o>*</span> <span class=n>normalWeight1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>w2</span> <span class=o>=</span> <span class=n>depthWeight2</span> <span class=o>*</span> <span class=n>normalWeight2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>w3</span> <span class=o>=</span> <span class=n>depthWeight3</span> <span class=o>*</span> <span class=n>normalWeight3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>w4</span> <span class=o>=</span> <span class=n>depthWeight4</span> <span class=o>*</span> <span class=n>normalWeight4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>w5</span> <span class=o>=</span> <span class=n>depthWeight5</span> <span class=o>*</span> <span class=n>normalWeight5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>w6</span> <span class=o>=</span> <span class=n>depthWeight6</span> <span class=o>*</span> <span class=n>normalWeight6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>w7</span> <span class=o>=</span> <span class=n>depthWeight7</span> <span class=o>*</span> <span class=n>normalWeight7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>w8</span> <span class=o>=</span> <span class=n>depthWeight8</span> <span class=o>*</span> <span class=n>normalWeight8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//weighted accumulation</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>color0</span> <span class=o>*</span> <span class=n>w0</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>color1</span> <span class=o>*</span> <span class=n>w1</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>color2</span> <span class=o>*</span> <span class=n>w2</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>color3</span> <span class=o>*</span> <span class=n>w3</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>color4</span> <span class=o>*</span> <span class=n>w4</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>color5</span> <span class=o>*</span> <span class=n>w5</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>color6</span> <span class=o>*</span> <span class=n>w6</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>color7</span> <span class=o>*</span> <span class=n>w7</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>color8</span> <span class=o>*</span> <span class=n>w8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>totalWeight</span> <span class=o>=</span> <span class=n>w0</span> <span class=o>+</span> <span class=n>w1</span> <span class=o>+</span> <span class=n>w2</span> <span class=o>+</span> <span class=n>w3</span> <span class=o>+</span> <span class=n>w4</span> <span class=o>+</span> <span class=n>w5</span> <span class=o>+</span> <span class=n>w6</span> <span class=o>+</span> <span class=n>w7</span> <span class=o>+</span> <span class=n>w8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>color</span> <span class=o>/=</span> <span class=nb>max</span><span class=p>(</span><span class=n>totalWeight</span><span class=p>,</span> <span class=mi>1</span><span class=n>e</span><span class=o>-</span><span class=mi>6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>color</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=temporal-instabilities><a href=#temporal-instabilities class=header-anchor></a>Temporal Instabilities</h2><p>Now, quick spoiler there is still a couple of more additional stages needed to improve the quality even more but I wanted to take a pause real quick because there is something very important here that we need to consider before moving forward.</p><p>Remember that context wise we are in a game setting <em>(or a real-time context)</em>. The camera will be moving and changing, so will the scene&mldr; so how does our work hold up when the camera starts to move?</p><p float=left><img src=content/vct-8th-raw.gif width=100%></p><p><em>1/8th Resolution (3 upsample passes)</em></p><p>Yikes! Not good at all.</p><p>There is a lot of flickering, and the lower we go resolution wise the worse the artifacts and flickering get&mldr;</p><p float=left><img src=content/vct-16th-raw.gif width=100%></p><p><em>1/16th Resolution (4 upsample passes)</em></p><p>This does make some sense&mldr; If you remember one of the tradeoffs I mentioned with reducing resolution is that since pixels become larger, that means when a pixel changes it&rsquo;s much more visible.</p><p>One of the issues I noticed when even using just upsampling is that in motion I had a lot of aliasing and instability when reducing the resolution of the lighting.</p><p>Not good at all&mldr; is there a way to fix this?</p><h3 id=temporal-instability-solutions-temporal-filtering><a href=#temporal-instability-solutions-temporal-filtering class=header-anchor></a>Temporal Instability Solutions: Temporal Filtering?</h3><p>Fortunately the industry has come up with a way to resolve such an issue. The technique is called temporal filtering. The idea is that you use previous frames and reproject into the current frame to gradually fade in any new pixel changes that occur.</p><p>I did go forward and implement this&mldr;</p><p float=left><img src=content/vct-8th-temporal-full.gif width=100%></p><p><em>1/8th Resolution (3 upsample passes) with Full Resolution Temporal Filtering</em></p><p>Ok good, this definetly solves a lot of the flickering!</p><p>But&mldr;</p><p>It&rsquo;s still visible in some spots, and just like any solution this introduces it&rsquo;s own set of problems. Problems that I find quite destructive to my final image quality.</p><ol><li><strong>Temporal Filtering relies on good Temporal Resolution.</strong> In english this means that the more frames you have, the better the quality/resolve. However! In games you often don&rsquo;t have the greatest temporal resolution anyway <em>(low FPS)</em>, and it can fluctuate! So the resolve worsens especially if you are on low spec hardware!</li></ol><p><img src=/p/adventures-global-illumination-downscaling/content/graphic-temproal-resolution.png width=1155 height=836 srcset="/p/adventures-global-illumination-downscaling/content/graphic-temproal-resolution_hu_72cadf39d5c8f866.png 480w, /p/adventures-global-illumination-downscaling/content/graphic-temproal-resolution_hu_eea0623fd2c5c396.png 1024w" loading=lazy alt=graphic-temproal-resolution class=gallery-image data-flex-grow=138 data-flex-basis=331px></p><ol start=2><li><strong>Temporal Filtering introduces ghosting/trailing artifacts.</strong> While additional attributes and conditions can be introduced to mitigate these artifacts, they will still be present in your image and you will have to constantly tweak and fight these artifacts that still muddy up your image quality in the end.</li></ol><p><img src=/p/adventures-global-illumination-downscaling/content/vct-8th-temporal-full.png width=1199 height=713 srcset="/p/adventures-global-illumination-downscaling/content/vct-8th-temporal-full_hu_347c90dc5febf580.png 480w, /p/adventures-global-illumination-downscaling/content/vct-8th-temporal-full_hu_4fd0f0c62bb38efd.png 1024w" loading=lazy alt=vct-8th-temporal-full class=gallery-image data-flex-grow=168 data-flex-basis=403px>
<em>1/8th Resolution With Full Resolution Temporal Filtering (3 upsample passes)</em></p><p><img src=/p/adventures-global-illumination-downscaling/content/vct-full-temporal-trails.png width=924 height=627 srcset="/p/adventures-global-illumination-downscaling/content/vct-full-temporal-trails_hu_4874bed373beee23.png 480w, /p/adventures-global-illumination-downscaling/content/vct-full-temporal-trails_hu_736c07fcb8020170.png 1024w" loading=lazy alt=vct-full-temporal-trails class=gallery-image data-flex-grow=147 data-flex-basis=353px>
<em>1/8th Resolution With Full Resolution Temporal Filtering, very visible trailing artifacts.</em></p><p>Part of my attempts to fix this also was to try doing the temporal filtering at 1/8th resolution instead of at full resolution.</p><p>Any artifacts brought on by the temporal filtering natrually would get blurred/smoothed out with the chained depth-normal aware upsampling that happens after.</p><p>Though I also suspected that some of the flickering artifacts with the upsample would come back when we do the temporal filter at a lower resolution. Since now we can no longer fade pixel changes at a finer scale with the higher resolution to alleviate some of those flickers in the first place.</p><p float=left><img src=content/vct-8th-temporal-8th.gif width=100%></p><p><em>1/8th Resolution Temporal Filtering with 3 depth-normal aware upsample passes after.</em></p><p>Yep, so some of the flickering artifacts have came back, that makes sense since now we are no longer doing the temporal filter at full resolution. So it can&rsquo;t take care of some of the flickering artifacts brought on by the upsampling.</p><p>As a plus atleast it seems the sharp trailing artifacts appear to be mostly gone now, but there seems to be some other oddities going on&mldr;</p><p><img src=/p/adventures-global-illumination-downscaling/content/vct-8th-temporal-8th.png width=1199 height=713 srcset="/p/adventures-global-illumination-downscaling/content/vct-8th-temporal-8th_hu_7d8668daa9db25c1.png 480w, /p/adventures-global-illumination-downscaling/content/vct-8th-temporal-8th_hu_b0996142a191821b.png 1024w" loading=lazy alt=vct-8th-temporal-8th class=gallery-image data-flex-grow=168 data-flex-basis=403px>
<em>1/8th Resolution With Full Resolution Temporal Filtering (3 upsample passes)</em></p><p>It appears that the image overall has gotten a lot softer. In addition also I am still seeing ghosting trails behind objects like I was before.</p><p><img src=/p/adventures-global-illumination-downscaling/content/vct-8th-temporal-trails.png width=1271 height=920 srcset="/p/adventures-global-illumination-downscaling/content/vct-8th-temporal-trails_hu_2affc03c14060f3f.png 480w, /p/adventures-global-illumination-downscaling/content/vct-8th-temporal-trails_hu_e6d2417be762617a.png 1024w" loading=lazy alt=vct-8th-temporal-trails class=gallery-image data-flex-grow=138 data-flex-basis=331px></p><p>The only difference now is that it&rsquo;s less sharp and more blurred out. It is an improvement over doing it at full resolution but even with some more tweaking these ghosts are still very visible and contribute to a much softer final image.</p><p>As a result most of these problems were enough to make me want to avoid using Temporal Filtering altogether. It ended up creating more problems than it was intended to solve so temporal filtering for me is out of the window here. There has to be another way to somehow smooth out these results without resorting to temporal filtering and the problems it creates.</p><p>Back to the drawing board&mldr;</p><h3 id=investigations-into-temporal-instabilities><a href=#investigations-into-temporal-instabilities class=header-anchor></a>Investigations into Temporal Instabilities</h3><p>I was geuinely curious as where this source of instability/flickering was coming from and if there was any kind of solution to solve it.</p><p>The global illumination technique I am using here is called Voxel Cone Tracing. I won&rsquo;t explain what it does because that is not what this article is about <em>(and it would take too long)</em>, but the algorithim itself does not introduce any inherent noise or a large amount of instability/flickering with how I have it setup.</p><p>So the flickering/instability has to be coming from somewhere else&mldr;</p><p>I decided to have a look at the other componets that get used to calculate the lighting. The main buffers that get used in the lighting calculations are the depth and normal buffers. If we look at the raw depth and normal buffer we are using for our inital lighting calculation, they look fine in motion.</p><p float=left><img src=content/full-depth-raw.gif width=49%>
<img src=content/normal-full-res-raw.gif width=49%></p><p><em>Left: Full Resolution Depth | Right: Full Resolution Scene Normals ([0..1] range)</em></p><p>But wait, we are looking at the full resolution buffers here, and the lighting gets calculated at a reduced resolution. Ok, so let&rsquo;s look at the buffers when it&rsquo;s being used in that low resolution context directly&mldr;</p><p float=left><img src=content/8th-depth-raw.gif width=49%>
<img src=content/normal-8th-raw.gif width=49%></p><p><em>Left: 1/8th Resolution Depth | Right: 1/8th Resolution Scene Normals ([0..1] range)</em></p><p>Interesting&mldr; there is a lot of flickering and instability happening here, why?</p><p>Well this is because when we are calculating lighting at a low resolution, we are using these high resolution buffers as-is. This is a problem because we can&rsquo;t use it at the full resolution <em>(we are working at 1/8th resolution)</em> so only portions of it gets used. As a result we actually wind up skipping pixels!</p><p>I&rsquo;ll show you what I mean.</p><p><img src=/p/adventures-global-illumination-downscaling/content/graphic-aliasing-explained.png width=2525 height=822 srcset="/p/adventures-global-illumination-downscaling/content/graphic-aliasing-explained_hu_54046852fa1806a0.png 480w, /p/adventures-global-illumination-downscaling/content/graphic-aliasing-explained_hu_96c9665dcf75917c.png 1024w" loading=lazy alt=graphic-aliasing-explained class=gallery-image data-flex-grow=307 data-flex-basis=737px></p><p>So here we are calculating at 1/8th resolution, when we just use the full resolution buffer as is, turns out it&rsquo;s picking only a single pixel from an entire region essentially 8x8 pixel region. Out of 64 possible pixels we are just picking out only 1 pixel!</p><p>As a result this leads to the flickering that we are seeing, because now the changes between pixels are much more drastic leading to this increased aliasing and flickering. This is also happening in our upsampling stages as well since we are using low resolution depth/normals to check differences with the high resolution variants.</p><p>Ok, is there a way we can actually utilize those other 63 pixels that are just flat out being skipped?</p><h3 id=temporal-instability-solutions-downsampling><a href=#temporal-instability-solutions-downsampling class=header-anchor></a>Temporal Instability Solutions: Downsampling?</h3><p>So before we can use our buffers in the 1/8th resolution context, we need to actually prepare them so they can be used in that 1/8th context properly. Downsampling can help us with that.</p><p>Downsampling is about taking a large set of data, and effectively &ldquo;compressing&rdquo; it down to a smaller set. It&rsquo;s essentially the reverse/opposite of upsampling we were doing earlier.</p><p><img src=/p/adventures-global-illumination-downscaling/content/graphic-downsampling-intro.png width=1920 height=1080 srcset="/p/adventures-global-illumination-downscaling/content/graphic-downsampling-intro_hu_fca57fdefee730a3.png 480w, /p/adventures-global-illumination-downscaling/content/graphic-downsampling-intro_hu_6266540af4675425.png 1024w" loading=lazy alt=graphic-downsampling-intro class=gallery-image data-flex-grow=177 data-flex-basis=426px></p><p>The simplest and most common downsampling algorithim used is just a simple average. Essentially you take any given number of samples, add them together and then divide by the sample count.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>4 5 4 4 4 6 5 4 7 6 6 4 (12 samples)
</span></span><span class=line><span class=cl>4 + 5 + 4 + 4 + 4 + 6 + 5 + 4 + 7 + 6 + 6 + 4 = 59 / 12 = 4.917
</span></span></code></pre></td></tr></table></div></div><p>Notice how there are some outlier samples in the set <em>(7)</em> but due to the other larger quanity of numbers that are similar in range the final averaged value comes out roughly to 4 - 5.</p><p>In the context of pixels/images, if a lot of pixels remain roughly the same then the final value will virtually be the same, but if there is some outliers in the set the influence of those samples natrually will get reduced/averaged out. This is an interesting behavior because one of the problems I mentioned that comes from reduced resolution is that pixel changes become more visible. If the surrounding pixels are mostly the same then the pixel changes will get averaged out.</p><p>So it sounds like there is an inherent temporal behavior happening here&mldr; Okay that seems sound&mldr; why not use it for those scene buffers as well.</p><p>In my pipeline I introduce passes now where I downsample both scene normal buffer and depth buffer so I can prepare them for use in the low resolution lighting calculations. It&rsquo;s similar to the upsampling chain setup, but I just do it in reverse now for downsampling.</p><p><img src=/p/adventures-global-illumination-downscaling/content/graphic-buffer-downsampling.png width=1761 height=692 srcset="/p/adventures-global-illumination-downscaling/content/graphic-buffer-downsampling_hu_b9258354b181a3e1.png 480w, /p/adventures-global-illumination-downscaling/content/graphic-buffer-downsampling_hu_af8bf63b472c918c.png 1024w" loading=lazy alt=graphic-buffer-downsampling class=gallery-image data-flex-grow=254 data-flex-basis=610px></p><p><em>NOTE: This was my inital downsampling pipeline, however an optimization <a class=link href=#optimization-bonus>that I mentioned earlier</a> that you can do is to pack both depth and normals into a single RGBA32 render target. This would save memory (and texture fetches later) and also simplify the pipeline here to just 1 render target that gets downsampled. Reducing draws and shader invocations, I recomend doing it.</em></p><p float=left><img src=content/8th-depth-downsample.png width=49%>
<img src=content/8th-normal-downsample.png width=49%></p><p><em>Left: 1/8th Resolution Scene Depth | Right: 1/8th Resolution Scene Normals ([0..1] range)</em></p><p>In my case I just use a very simple 2x2 downsample average. Different downsampling filters could likely be utilized here but I wanted to start simple.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-HLSL data-lang=HLSL><span class=line><span class=cl><span class=kt>float4</span> <span class=n>DownsampleAverage2x2</span><span class=p>(</span><span class=kt>float2</span> <span class=n>uv</span><span class=p>,</span> <span class=kt>float2</span> <span class=n>texelSize</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>color</span> <span class=o>=</span> <span class=n>ColorSample</span><span class=p>(</span><span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span><span class=n>texelSize</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=mo>0</span><span class=p>))</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=n>ColorSample</span><span class=p>(</span><span class=n>uv</span> <span class=o>-</span> <span class=kt>float2</span><span class=p>(</span><span class=n>texelSize</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=mo>0</span><span class=p>))</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=n>ColorSample</span><span class=p>(</span><span class=n>uv</span> <span class=o>+</span> <span class=kt>float2</span><span class=p>(</span><span class=mo>0</span><span class=p>,</span> <span class=n>texelSize</span><span class=p>.</span><span class=n>y</span><span class=p>))</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=n>ColorSample</span><span class=p>(</span><span class=n>uv</span> <span class=o>-</span> <span class=kt>float2</span><span class=p>(</span><span class=mo>0</span><span class=p>,</span> <span class=n>texelSize</span><span class=p>.</span><span class=n>y</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>color</span> <span class=o>*</span> <span class=mf>0.25f</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>So let&rsquo;s apply this downsample filter chain and check what the normal buffer looks like in motion now&mldr;</p><p float=left><img src=content/8th-depth-downsample.gif width=49%>
<img src=content/normal-8th-downsampled.gif width=49%></p><p>Ooooo! So after applying a downsample filter to our normal buffer <em>(and depth buffer)</em>, much of the flickering actually vanishes when looking at the buffers by itself. This is promising&mldr;</p><p>I went ahead and applied the same downsampling process to the depth buffer as well. Now I&rsquo;m left with these scene buffers downsampled to the resolution that the lighting gets calculated at, so lets use them now for calculating lighting <em>(and the upsampling stages)</em> and see what happens&mldr; <em>(Looking at the still frame first)</em></p><p><img src=/p/adventures-global-illumination-downscaling/content/vct-8th-downsampled.png width=1199 height=713 srcset="/p/adventures-global-illumination-downscaling/content/vct-8th-downsampled_hu_d67e14c48caa255f.png 480w, /p/adventures-global-illumination-downscaling/content/vct-8th-downsampled_hu_251b5551acb1e763.png 1024w" loading=lazy alt=vct-8th-downsampled class=gallery-image data-flex-grow=168 data-flex-basis=403px>
<em>1/8th Resolution (3 upsample passes)</em></p><p>Ok interesting&mldr; I can actually see a lot less pixelation now compared to before even in a still frame, and the lighting results are slightly different. Some spots do appear wierder <em>(I&rsquo;ll explain why that is in a bit)</em> but for the most part everything still looks pretty good.</p><p>So how does this look in motion now?</p><p float=left><img src=content/vct-8th-downsampled.gif width=100%></p><p><em>1/8th Resolution (3 upsample passes)</em></p><p>Wow! Massive difference!</p><p>We can see this gets more dramatic also when we reduce the resolution much further and pile up more progressive upsamples. It remains pretty stable temporally, even when we are as low as 1/16th resolution!</p><p float=left><img src=content/vct-16th-downsampled.gif width=100%></p><p><em>1/16th Resolution (4 upsample passes)</em></p><p>Granted we can make out some funk in the quality. The pixelation does get more visible when we go lower, but of course that is because downsampling is not a perfect solution. Every solution introduces their own set of issues, but I find the issues here much more tame and less visible than temporal filtering artifacts like ghosting/trails that we saw before <em>(and being bound by temporal resolution)</em>. Importantly for me, the scene remains sharp even in motion.</p><p>Still, I want to explore why our lighting looks a little different <em>(might even be considered worse in some areas)</em>.</p><h3 id=downsampling---drawbacks><a href=#downsampling---drawbacks class=header-anchor></a>Downsampling - Drawbacks</h3><p>With downsampling, we reduce a set of pixels down to one, and effectively construct a fresh and unique new pixel value. Ok sure that makes sense, that is what we were trying to do in order to gain temporal stability in the first place.</p><p>But I want to explain the drawbacks of downsampling in this context, and why some graphics programmers shy away from doing this <em>(and for good reason)</em>.</p><p>The reason being that with downsampling, you are creating a fresh new pixel out of a set of original pixels. In the context of depth, you are taking a set of original depth values, are a creating a fresh new unqiue depth value. <strong>A depth value that of which does not exist in the original depth buffer.</strong> <em>(Same with the normal buffer)</em></p><p>If you recall back to the basic math example from earlier&mldr;</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>4 5 4 4 4 6 5 4 7 6 6 4 (12 samples)
</span></span><span class=line><span class=cl>4 + 5 + 4 + 4 + 4 + 6 + 5 + 4 + 7 + 6 + 6 + 4 = 59 / 12 = 4.917
</span></span></code></pre></td></tr></table></div></div><p>The final averaged value is 4.917, which is close to 5 but <strong>4.917 is a value that never actually existed in the original set.</strong></p><p>Technically this means that if you are doing a lighting calculation for example, you use depth to reconstruct the position of a pixel so you can calculate the lighting at that point.</p><p><strong>When you introduce downsampling, that depth value actually changes so when you calculate position now, it actually gets shifted and that means the lighting at a given surface point is actually not 100% accurate.</strong> It&rsquo;s in the wrong spot! Either its slightly pushed forward or slightly pushed backwards depending on the surrounding pixels of that region. In our image in some spots this can actually introduce a &ldquo;halo&rdquo; around some objects in the foreground.</p><p><img src=/p/adventures-global-illumination-downscaling/content/vct-8th-downsampled-halo.png width=738 height=789 srcset="/p/adventures-global-illumination-downscaling/content/vct-8th-downsampled-halo_hu_2f4164bf8fd0f974.png 480w, /p/adventures-global-illumination-downscaling/content/vct-8th-downsampled-halo_hu_a76ea6ad68404b7e.png 1024w" loading=lazy alt=vct-8th-downsampled-halo class=gallery-image data-flex-grow=93 data-flex-basis=224px>
<em>1/8th Resolution (3 upsample passes)</em></p><p>This also applies to the normals as well, surface normals within an area get averaged to form a new normal value. This normal value is then shifted in a different direction leading to slightly different lighting results for some surfaces.</p><p>Now if this is a concern, there are different downsampling filters that exist. For instance with depth it&rsquo;s common to actually use a min or max filter since those will pick either the closest <em>(or farthest)</em> pixel that was in the set and use that. However Min/Max does not average out pixel changes across an area so that inherent temporal behavior I described with averaging does not happen.</p><p>This is why temporal filtering is also attractive to some graphics programmers <em>(and by extension, why some of the industry is pushing for it)</em>. It is because it does a better job at retaining &ldquo;correctness&rdquo; or accuracy of those original samples.</p><p>Some even take it as far introducing &ldquo;jittering&rdquo;. If you remember also from earlier when I described the inital problem of how we only picked 1 pixel out of a region of 8x8 pixels&mldr;</p><p>With jittering, we still ultimately choose 1 pixel from the region, but with the concept of time/temporal in the mix we actually change which pixel we choose within that region every frame. Across 4 frames we chose 4 different pixels from that region. Natrually the temporal filtering will blend these pixels together and we retain correctness.</p><p>But that is still 4 pixels out of a total of 64 in that 8x8 region, we could introduce more jitter samples across time. But covering the full 64 samples across 64 frames requires a lot of temporal resolution. Temporal resolution that often we don&rsquo;t have, considering the common target framerate for games are 60 frames a second, and a lot can change in a second!</p><p>You could also try not dropping the resolution that far. For example just going down to a quarter resolution <em>(rather than 1/8th)</em> gives you a 4x4 pixel region of 4x4 = 16 pixels. Less samples that you need to cover, but still thats 16 frames of blending needed across time.</p><p>An interesting solution that the industry is also adopting is a combination of these two ideas so to speak. This amounts to Spatio-Temporal upsampling and this interestingly actually starts leading into the core ideas behind upscalars like FSR, DLSS, Intel XeSS. Where you have a spatial component of the filter that takes care of smoothing out pixels across an area, and the temporal component takes care of smoothing out pixel changes across time.</p><p>However&mldr; as I pointed out, temporal filtering at large still introduces visual issues that I&rsquo;m not a fan of so I would like to avoid it if I can.</p><p>So ultimately I just went forward with downsampling as my main solution for temporal stability as the gains were to significant to ignore. Outside of that I don&rsquo;t know any other techniques or solutions that could be employed. <em>(NOTE: If you do have a solution or know of one, PLEASE LET ME KNOW!)</em>.</p><p>This doesn&rsquo;t apply just to depth of course, this applies to the other scene buffers that get downsampled as well. Normals will be shifted, and with the Specular buffer those values get shifted as well.</p><h4 id=temporal-solution-comparisons><a href=#temporal-solution-comparisons class=header-anchor></a>Temporal Solution Comparisons</h4><p float=left><img src=content/vct-8th-temporal-full.gif width=49%>
<img src=content/vct-8th-downsampled.gif width=49%></p><p><em>Left: 1/8th Resolution With Full Resolution Temporal Filter | Right: 1/8th Resolution With Downsampled Buffers</em></p><p float=left><img src=content/vct-8th-raw.gif width=49%>
<img src=content/vct-8th-downsampled.gif width=49%></p><p><em>Left: 1/8th Resolution No Downsampled Buffers | Right: 1/8th Resolution With Downsampled Buffers</em></p><p float=left><img src=content/vct-16th-raw.gif width=49%>
<img src=content/vct-16th-downsampled.gif width=49%></p><p><em>Left: 1/16th Resolution No Downsampled Buffers | Right: 1/16th Resolution With Downsampled Buffers</em></p><p>So to conclude this section I want to share what the pipeline looks. You might have missed it but I also mentioned that the downsampled buffers also get used in each of the upsampling stages. They are all stored in the mip levels so with each progressive upsample we use the respective mip level <em>(that holds the downsampled render target)</em> which helps alot with improving temproal stability in the final image. We also pointed out that it improves the spatial quality as well reducing pixelation on the final frame.</p><p><img src=/p/adventures-global-illumination-downscaling/content/graphic-full-pipeline-after-downsampling.png width=4115 height=1302 srcset="/p/adventures-global-illumination-downscaling/content/graphic-full-pipeline-after-downsampling_hu_db47f22cf82a98c1.png 480w, /p/adventures-global-illumination-downscaling/content/graphic-full-pipeline-after-downsampling_hu_90903ecf1277a1d.png 1024w" loading=lazy alt=vct-8th-downsampled class=gallery-image data-flex-grow=316 data-flex-basis=758px></p><h2 id=upsampling---how-to-go-further><a href=#upsampling---how-to-go-further class=header-anchor></a>Upsampling - How to go further?</h2><p><img src=/p/adventures-global-illumination-downscaling/content/vct-8th-downsampled.png width=1199 height=713 srcset="/p/adventures-global-illumination-downscaling/content/vct-8th-downsampled_hu_d67e14c48caa255f.png 480w, /p/adventures-global-illumination-downscaling/content/vct-8th-downsampled_hu_251b5551acb1e763.png 1024w" loading=lazy alt=vct-8th-downsampled class=gallery-image data-flex-grow=168 data-flex-basis=403px>
<em>1/8th Resolution (3 upsample passes)</em></p><p>Shifting gears back to improving the spatial quality of the lighting <em>(now with the temporal component at a decent spot)</em>, even with the downsampled buffers and the best upsampling I was able to find, this still was not convincing enough for me even at lower resolutions because surfaces still get smeared too much!</p><p>So we need to take a step back and think as to why this is really happening. Why are the surfaces looking so smeary/blurry?</p><p>Well when we do lighting, surface position matters a great deal. That is mostly already covered though fortunately thanks to the depth-aware upsampling that we do.</p><p>Another factor that significantly affects the lighting of a surface is it&rsquo;s orientation, or normal. The depth-normal-aware upsampling again help with this but it&rsquo;s still not enough&mldr; so what&rsquo;s missing?</p><p>Do we need another scene attribute?</p><p>Well for diffuse lighting we have the surface position, and the surface normal. We do have surface roughness and metallic, but those are meant for specular and don&rsquo;t have an effect on the actual diffuse term&mldr; mabye surface occlusion?</p><p>Sure lets try that. Most materials/objects in my project have an authored ambient occlusion map, let&rsquo;s try factoring that in.</p><p><img src=/p/adventures-global-illumination-downscaling/content/scene-occlusion.png width=1199 height=713 srcset="/p/adventures-global-illumination-downscaling/content/scene-occlusion_hu_6569e4f5c26ed72.png 480w, /p/adventures-global-illumination-downscaling/content/scene-occlusion_hu_48d1818c10bb75cf.png 1024w" loading=lazy alt=scene-occlusion class=gallery-image data-flex-grow=168 data-flex-basis=403px>
<em>Full Resolution Scene Material Occlusion</em></p><p>Applying occlusion by just multiplying the final lighting buffer with it.</p><p><img src=/p/adventures-global-illumination-downscaling/content/vct-8th-downsampled-and-occlusion.png width=1199 height=713 srcset="/p/adventures-global-illumination-downscaling/content/vct-8th-downsampled-and-occlusion_hu_f90f5722d529c912.png 480w, /p/adventures-global-illumination-downscaling/content/vct-8th-downsampled-and-occlusion_hu_cafb94bcb102230c.png 1024w" loading=lazy alt=vct-8th-downsampled-and-occlusion class=gallery-image data-flex-grow=168 data-flex-basis=403px>
<em>1/8th Resolution (3 upsample passes) + Full Resolution Material Occlusion</em></p><p>Ok&mldr; that helped, but it&rsquo;s not good enough.</p><p>We can still see underneath it that things are blurred and smeary, some objects in the scene still turn into a blobby mess.</p><p><img src=/p/adventures-global-illumination-downscaling/content/vct-8th-downsampled-and-occlusion-zoomed.png width=884 height=766 srcset="/p/adventures-global-illumination-downscaling/content/vct-8th-downsampled-and-occlusion-zoomed_hu_7b342deee579fe3f.png 480w, /p/adventures-global-illumination-downscaling/content/vct-8th-downsampled-and-occlusion-zoomed_hu_e58e9a4413bed6db.png 1024w" loading=lazy alt=vct-8th-downsampled-and-occlusion-zoomed class=gallery-image data-flex-grow=115 data-flex-basis=276px>
<em>1/8th Resolution (3 upsample passes) + Full Resolution Material Occlusion</em></p><p>What&rsquo;s worse is that some object&rsquo;s in my project don&rsquo;t <em>(and wont)</em> have authored ambient occlusion maps, so those will be left out completely!</p><p>We don&rsquo;t have any other scene attributes we can really utilize here to push things further, so we are kind of stuck. We have to look deeper, and really examine why things are blurred and smeary.</p><p>Now conceptually for each pixel we only have a single color that we are juggling around a given image region. We are much more selective now as to where we place this color value. But it&rsquo;s only just a color value&mldr; mabye we need more than just 1 color value per pixel?</p><p>Ok sure, having more color values would help, but in order to get more data shouldn&rsquo;t we increase resolution to do that?</p><p>We can&mldr; but that leads to worse performance, and that goes against what we were trying to do in the first place, which was reduce resolution and do all this upsampling!</p><p>Ok&mldr; is there another way we can increase the amount of data without doing that?</p><h3 id=spherical-harmonics><a href=#spherical-harmonics class=header-anchor></a>Spherical Harmonics</h3><p><img src=/p/adventures-global-illumination-downscaling/content/spherical-harmonics-graphic.png width=1280 height=800 srcset="/p/adventures-global-illumination-downscaling/content/spherical-harmonics-graphic_hu_4a64521209b1d994.png 480w, /p/adventures-global-illumination-downscaling/content/spherical-harmonics-graphic_hu_8f2847816b89d426.png 1024w" loading=lazy alt=spherical-harmonics class=gallery-image data-flex-grow=160 data-flex-basis=384px>
<em>Image by Iigo Quilez illustrating the directions that Spherical Harmonics can represent. 3 orders are represented here from top to bottom. Order 0, 1, 2, 3.</em></p><p>You may have heard or know of it, mabye not. The fancy name does tend to scare away quite a few people but it&rsquo;s fairly simple in practice.</p><p>The general problem we are faced with is that we need to introduce more data in order to shade more accurately. We need more lighting information at a given pixel than just one single color. This is where spherical harmonics can help us.</p><p>Spherical harmonics take a given spherical signal/data, and sum it up to a set of coefficents that you sample later. <em>(You can think of them almost like a really small cubemap)</em>. Spherical Harmonics have orders, the more orders you have the more data/coefficents you end up with <em>(and effectively better quality)</em>.</p><p>I&rsquo;ve set up an example in a different project here to demonstrate Spherical Harmonics. It is a simple environment that will be lit entirely with an HDRI cubemap that is projected into spherical harmonic coefficents. Starting with Order 0, graphically it&rsquo;s the single top element.</p><p><img src=/p/adventures-global-illumination-downscaling/content/spherical-harmonics-graphic-order-0.png width=139 height=136 srcset="/p/adventures-global-illumination-downscaling/content/spherical-harmonics-graphic-order-0_hu_ac21c247948bf7d3.png 480w, /p/adventures-global-illumination-downscaling/content/spherical-harmonics-graphic-order-0_hu_951b3a93c47c836b.png 1024w" loading=lazy alt=spherical-harmonics-order-0 class=gallery-image data-flex-grow=102 data-flex-basis=245px></p><p>This single float3 coefficent is the average color of the whole lighting environment. Technically this is exactly what is happening with our current lighting setup, it is just a single color we are throwing around.</p><p><img src=/p/adventures-global-illumination-downscaling/content/sh0-only.png width=1165 height=626 srcset="/p/adventures-global-illumination-downscaling/content/sh0-only_hu_9acdcff19a1fabb5.png 480w, /p/adventures-global-illumination-downscaling/content/sh0-only_hu_6ca1251c4987905d.png 1024w" loading=lazy alt=sh0-only class=gallery-image data-flex-grow=186 data-flex-basis=446px>
<em>Spherical Harmonics Order 0 (1 total coefficent)</em></p><p><img src=/p/adventures-global-illumination-downscaling/content/sh-wireframe.png width=1165 height=626 srcset="/p/adventures-global-illumination-downscaling/content/sh-wireframe_hu_d1d78ac1ad87c8f6.png 480w, /p/adventures-global-illumination-downscaling/content/sh-wireframe_hu_2de0179fe5da5c37.png 1024w" loading=lazy alt=sh-wireframe class=gallery-image data-flex-grow=186 data-flex-basis=446px>
<em>Scene Wireframe</em></p><p>I shared the wireframe here to show the scene since you wouldn&rsquo;t be able to make it out otherwise. But with how this scene is setup, having a single color is not enough to light these objects correctly.</p><p>Things like occlusion of course could be used to help with shading just like we tried before&mldr;</p><p><img src=/p/adventures-global-illumination-downscaling/content/sh0-occlusion.png width=1165 height=626 srcset="/p/adventures-global-illumination-downscaling/content/sh0-occlusion_hu_13b792e3ade89b82.png 480w, /p/adventures-global-illumination-downscaling/content/sh0-occlusion_hu_f30c413e8969454e.png 1024w" loading=lazy alt=sh0-occlusion class=gallery-image data-flex-grow=186 data-flex-basis=446px>
<em>Spherical Harmonics Order 0 (1 total coefficent) + SSAO</em></p><p>But as we also saw and learned previously&mldr;</p><p>Occlusion, regardless of what kind of flavor we may be using here <em>(SSAO, Material Occlusion, Lightmaps, etc)</em> is still not enough. More importantly it does not solve the underlying problem of the smeary/blurry lighting. Again this is because we are dealing with just a single color for the lighting.</p><p>We need more information than just a single color from our lighting environment. So lets bump the order up so we can gather more data to better shade our scene! With Order 1 we add 3 extra coefficents that are oriented to a specific direction&mldr;</p><p><img src=/p/adventures-global-illumination-downscaling/content/spherical-harmonics-graphic-order-1.png width=528 height=192 srcset="/p/adventures-global-illumination-downscaling/content/spherical-harmonics-graphic-order-1_hu_375d6fd3a7f996af.png 480w, /p/adventures-global-illumination-downscaling/content/spherical-harmonics-graphic-order-1_hu_7a970ee57f1c02cb.png 1024w" loading=lazy alt=spherical-harmonics-order-1 class=gallery-image data-flex-grow=275 data-flex-basis=660px>
<em>Spherical Harmonics Order 1 (3 coefficents this order introduces)</em></p><p>This is now where you see the upsides to using spherical harmonics, because each coefficent now essentially provides us with more detailed information about the lighting environment&mldr;</p><ul><li><strong>Spherical Harmonic Coefficent 0</strong> <em>(L = 0, M = 0)</em>: Describes the average color of the whole lighting environment.</li><li><strong>Spherical Harmonic Coefficent 1</strong> <em>(L = 1, M = -1)</em>: Describes the average left/right lighting color of the environment.</li><li><strong>Spherical Harmonic Coefficent 2</strong> <em>(L = 1, M = 0)</em>: Describes the average top/down lighting color of the environment.</li><li><strong>Spherical Harmonic Coefficent 3</strong> <em>(L = 1, M = 1)</em>: Describes the average forward/back lighting color of the environment.</li></ul><p>At shading time we take the coefficents, project them reconstruct the spherical harmonic enviornment and then sample using the surface normal.</p><p><img src=/p/adventures-global-illumination-downscaling/content/sh1.png width=1165 height=626 srcset="/p/adventures-global-illumination-downscaling/content/sh1_hu_cb7cfeb3a0f76bff.png 480w, /p/adventures-global-illumination-downscaling/content/sh1_hu_95ce84abb1ef9ac5.png 1024w" loading=lazy alt=sh1 class=gallery-image data-flex-grow=186 data-flex-basis=446px>
<em>Spherical Harmonics Order 1 (4 total coefficents)</em></p><p>You can see now we can read depth and shapes from the scene now since we are shading with more than just a single color from the environment. Depending on the orentation of the surface we get different colors that corespond to the lighting environment.</p><p>All of that just from 4 float3 colors!</p><p><img src=/p/adventures-global-illumination-downscaling/content/spherical-harmonics-graphic-order-0-and-1.png width=521 height=349 srcset="/p/adventures-global-illumination-downscaling/content/spherical-harmonics-graphic-order-0-and-1_hu_2d3c7f36ae11a96a.png 480w, /p/adventures-global-illumination-downscaling/content/spherical-harmonics-graphic-order-0-and-1_hu_ae54725aa1a8c212.png 1024w" loading=lazy alt=spherical-harmonics-order-0-and-1 class=gallery-image data-flex-grow=149 data-flex-basis=358px>
<em>Spherical Harmonics Order 0 and 1 (4 total coefficents)</em></p><p>Now we could go further and introduce more orders, which would give us better resolution and quality&mldr; However introducing more coefficents would make things a little heavier memory wise and even a little more expensive at evaluation time.</p><p>Remember that with each new Spherical Harmonic order you introduce a new set of coefficents that makeup that order and need to be sampled.</p><p>With Diffuse/Irradiance Lighting, it&rsquo;s very common to at most use up to Order 1. This is because diffuse lighting tends to always be very blurry and low-frequency. Using more orders on a phenomena that is natrually blurry and low-frequency would be wasteful. <em>(At most Order 2 is used for Diffuse/Irradiance)</em></p><p>So to keep things light and simple, we will just stick with up to Order 1 Spherical Harmonics. I would dive more into detail but just trust me on this :D</p><p>Ok fine, so how can we use it?</p><h3 id=spherical-harmonics-how-to-apply-it><a href=#spherical-harmonics-how-to-apply-it class=header-anchor></a>Spherical Harmonics: How to apply it?</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-HLSL data-lang=HLSL><span class=line><span class=cl><span class=c1>//ORDER = 0 | M = 0</span>
</span></span><span class=line><span class=cl><span class=kt>float</span> <span class=n>SphericalHarmonicBasis0</span><span class=p>(</span><span class=kt>float3</span> <span class=n>dir</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//return 0.5f * sqrt(1.0f / PI);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mf>0.282094791773878f</span><span class=p>;</span> <span class=c1>//precomputed</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//ORDER = 1 | M = -1</span>
</span></span><span class=line><span class=cl><span class=kt>float</span> <span class=n>SphericalHarmonicBasis1</span><span class=p>(</span><span class=kt>float3</span> <span class=n>dir</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//return sqrt(3.0f / (4.0f * PI)) * dir.y;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mf>0.48860251190292f</span> <span class=o>*</span> <span class=n>dir</span><span class=p>.</span><span class=n>y</span><span class=p>;</span> <span class=c1>//precomputed</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//ORDER = 1 | M = 0</span>
</span></span><span class=line><span class=cl><span class=kt>float</span> <span class=n>SphericalHarmonicBasis2</span><span class=p>(</span><span class=kt>float3</span> <span class=n>dir</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//return sqrt(3.0f / (4.0f * PI)) * dir.z;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mf>0.48860251190292f</span> <span class=o>*</span> <span class=n>dir</span><span class=p>.</span><span class=n>z</span><span class=p>;</span> <span class=c1>//precomputed</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//ORDER = 1 | M = 1</span>
</span></span><span class=line><span class=cl><span class=kt>float</span> <span class=n>SphericalHarmonicBasis3</span><span class=p>(</span><span class=kt>float3</span> <span class=n>dir</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//return sqrt(3.0f / (4.0f * PI)) * dir.x;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mf>0.48860251190292f</span> <span class=o>*</span> <span class=n>dir</span><span class=p>.</span><span class=n>x</span><span class=p>;</span> <span class=c1>//precomputed</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>These are the spherical harmonic basis functions, but in order to use these we need to shift things a bit in our original lighting function.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-HLSL data-lang=HLSL><span class=line><span class=cl><span class=kt>float3</span> <span class=n>finalIrradiance</span> <span class=o>=</span> <span class=kt>float3</span><span class=p>(</span><span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mo>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>ConeTraceDirections</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//get ray direction over a HEMI-SPHERE that is oriented with the surface normal</span>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>random</span> <span class=o>=</span> <span class=n>Hammersley2dSeq</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>ConeTraceDirections</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float3</span> <span class=n>vector_rayDirection</span> <span class=o>=</span> <span class=n>SampleHemisphereCosine</span><span class=p>(</span><span class=n>random</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=n>random</span><span class=p>.</span><span class=n>y</span><span class=p>,</span> <span class=n>vector_sceneShadingNormals</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//do cone tracing...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//add final result</span>
</span></span><span class=line><span class=cl>    <span class=n>finalIrradiance</span> <span class=o>+=</span> <span class=n>coneTraceResult</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//average samples</span>
</span></span><span class=line><span class=cl><span class=n>finalIrradiance</span> <span class=o>/=</span> <span class=n>ConeTraceDirections</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>Instead of returning/outputing the <em><strong>final</strong></em> singular color lighting based on the surface position and orientation at a given point&mldr; We want to return more data/colors that describe the lighting environment at that specific point.</p><p>We shift things to where we switch to calculating the full 360 degree lighting environment from that point <em>(instead of a hemisphere like before)</em> and store that result into SH coefficents that can be sampled later.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-HLSL data-lang=HLSL><span class=line><span class=cl><span class=kt>float3</span> <span class=n>irradianceL0</span> <span class=o>=</span> <span class=kt>float3</span><span class=p>(</span><span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>float3</span> <span class=n>irradianceL10</span> <span class=o>=</span> <span class=kt>float3</span><span class=p>(</span><span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>float3</span> <span class=n>irradianceL11</span> <span class=o>=</span> <span class=kt>float3</span><span class=p>(</span><span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>float3</span> <span class=n>irradianceL12</span> <span class=o>=</span> <span class=kt>float3</span><span class=p>(</span><span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mo>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>ConeTraceDirections</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//get ray direction over a SPHERE</span>
</span></span><span class=line><span class=cl>    <span class=c1>//not a hemisphere since we want info about the whole spherical lighting environment</span>
</span></span><span class=line><span class=cl>    <span class=kt>float2</span> <span class=n>random</span> <span class=o>=</span> <span class=n>Hammersley2dSeq</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>ConeTraceDirections</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float3</span> <span class=n>vector_rayDirection</span> <span class=o>=</span> <span class=n>SampleSphereUniform</span><span class=p>(</span><span class=n>random</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=n>random</span><span class=p>.</span><span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//do cone tracing...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//then add final results...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//spherical harmonics order 0</span>
</span></span><span class=line><span class=cl>    <span class=n>irradianceL0</span> <span class=o>+=</span> <span class=n>coneTraceResult</span><span class=p>.</span><span class=n>rgb</span> <span class=o>*</span> <span class=n>SphericalHarmonicBasis0</span><span class=p>(</span><span class=n>vector_rayDirection</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//spherical harmonics order 1</span>
</span></span><span class=line><span class=cl>    <span class=n>irradianceL10</span> <span class=o>+=</span> <span class=n>coneTraceResult</span><span class=p>.</span><span class=n>rgb</span> <span class=o>*</span> <span class=n>SphericalHarmonicBasis1</span><span class=p>(</span><span class=n>vector_rayDirection</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>irradianceL11</span> <span class=o>+=</span> <span class=n>coneTraceResult</span><span class=p>.</span><span class=n>rgb</span> <span class=o>*</span> <span class=n>SphericalHarmonicBasis2</span><span class=p>(</span><span class=n>vector_rayDirection</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>irradianceL12</span> <span class=o>+=</span> <span class=n>coneTraceResult</span><span class=p>.</span><span class=n>rgb</span> <span class=o>*</span> <span class=n>SphericalHarmonicBasis3</span><span class=p>(</span><span class=n>vector_rayDirection</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//average samples</span>
</span></span><span class=line><span class=cl><span class=kt>float</span> <span class=n>scalar</span> <span class=o>=</span> <span class=p>(</span><span class=mf>2.0f</span> <span class=o>*</span> <span class=n>PI</span> <span class=o>/</span> <span class=n>ConeTraceDirections</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>irradianceL0</span> <span class=o>*=</span> <span class=n>scalar</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>irradianceL10</span> <span class=o>*=</span> <span class=n>scalar</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>irradianceL11</span> <span class=o>*=</span> <span class=n>scalar</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>irradianceL12</span> <span class=o>*=</span> <span class=n>scalar</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//you can also do other things with the SH coefficents here...</span>
</span></span><span class=line><span class=cl><span class=c1>//1. convolve coefficents for irradiance</span>
</span></span><span class=line><span class=cl><span class=c1>//2. deringing</span>
</span></span></code></pre></td></tr></table></div></div><p>Now, in practice though with render targets and fragment shaders we typically only output 1 RGBA color.</p><p>But in our case we have these 4 RGB colors that we now need to return? We can&rsquo;t exactly squeeze 4 RGB colors into a single output RGBA. So how can we output all the data that we need?</p><p>I&rsquo;m going to keep things brief at first, but later <a class=link href=#spherical-harmonic-optimizations-render-target-packing>I explain the specifics of the packing and optimizations later here</a>, but a short summary is that we can actually do some basic swizzling to pack the 4 RGB colors into just effectively 3 float4&rsquo;s.</p><p>That alleviates the pressure a bit but we still end up with 3 float4s. Well we need to change things in our backend quite a bit to something that would allow us to output more data from a shader. <a class=link href=#spherical-harmonic-optimizations-compute-shader>A compute shader can do this</a>, so we move our lighting calculation function into one and at the end of it we output the packed float4 coefficents into 3 render targets simultanoeusly.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-HLSL data-lang=HLSL><span class=line><span class=cl><span class=kt>RWTexture2D</span><span class=o>&lt;</span><span class=kt>float4</span><span class=o>&gt;</span> <span class=n>VoxelConeTraceSHA</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>RWTexture2D</span><span class=o>&lt;</span><span class=kt>float4</span><span class=o>&gt;</span> <span class=n>VoxelConeTraceSHB</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>RWTexture2D</span><span class=o>&lt;</span><span class=kt>float4</span><span class=o>&gt;</span> <span class=n>VoxelConeTraceSHC</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#pragma kernel VoxelConeTracing</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nd>numthreads</span><span class=p>(</span><span class=n>THREAD_GROUP_SIZE_X</span><span class=p>,</span> <span class=n>THREAD_GROUP_SIZE_Y</span><span class=p>,</span> <span class=n>THREAD_GROUP_SIZE_Z</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>VoxelConeTracing</span><span class=p>(</span><span class=kt>uint3</span> <span class=n>id</span> <span class=o>:</span> <span class=nd>SV_DispatchThreadID</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//the 3 float4&#39;s that we will output...</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>irradianceSHA</span> <span class=o>=</span> <span class=kt>float4</span><span class=p>(</span><span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>irradianceSHB</span> <span class=o>=</span> <span class=kt>float4</span><span class=p>(</span><span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>irradianceSHC</span> <span class=o>=</span> <span class=kt>float4</span><span class=p>(</span><span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//calculate cone tracing like normal...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//pack the spherical harmonic irradiance coefficents</span>
</span></span><span class=line><span class=cl>    <span class=n>SphericalHarmonicsPackIrradiance_ColorL1</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=c1>//input coefficents</span>
</span></span><span class=line><span class=cl>        <span class=n>irradianceL0</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=n>irradianceL10</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=n>irradianceL11</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=n>irradianceL12</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>//output color</span>
</span></span><span class=line><span class=cl>        <span class=n>irradianceSHA</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>irradianceSHB</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>irradianceSHC</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//output the float4&#39;s simultanoeusly</span>
</span></span><span class=line><span class=cl>    <span class=n>VoxelConeTraceSHA</span><span class=p>[</span><span class=n>id</span><span class=p>.</span><span class=n>xyz</span><span class=p>]</span> <span class=o>=</span> <span class=n>irradianceSHA</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>VoxelConeTraceSHB</span><span class=p>[</span><span class=n>id</span><span class=p>.</span><span class=n>xyz</span><span class=p>]</span> <span class=o>=</span> <span class=n>irradianceSHB</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>VoxelConeTraceSHC</span><span class=p>[</span><span class=n>id</span><span class=p>.</span><span class=n>xyz</span><span class=p>]</span> <span class=o>=</span> <span class=n>irradianceSHC</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p float=left><img src=content/vct-sha.png width=32%>
<img src=content/vct-shb.png width=32%>
<img src=content/vct-shc.png width=32%></p><p><em>Left To Right: SHA (Render Target 0) | SHB (Render Target 1) | SHC (Render Target 2)</em></p><p>I still retain all of the upsampling and filtering passes I had before, but I just do them with each of the SH render targets. <em><a class=link href=#spherical-harmonic-optimizations-compute-shader>(I also moved these to a compute shader)</a></em></p><p>After upsampling the SH render targets to full resolution, I do an additional final pass where we sample the SH lighting environment using the full resolution scene normal, and this is the result.</p><p><img src=/p/adventures-global-illumination-downscaling/content/vct-8th-sh.png width=1199 height=713 srcset="/p/adventures-global-illumination-downscaling/content/vct-8th-sh_hu_116eae8a6b771d4f.png 480w, /p/adventures-global-illumination-downscaling/content/vct-8th-sh_hu_cb2ab2c75bcf5cdf.png 1024w" loading=lazy alt=vct-8th-sh class=gallery-image data-flex-grow=168 data-flex-basis=403px>
<em>1/8th Resolution (3 upsample passes)</em></p><p>Woah! We can see now that scene details are retained very well now. Normal maps and granular details are actually visible and no longer overly smeared, and all of the underlying of the scene artwork is kept in tact.</p><p>More importantly also the final lighting now is properly convincing at the resolution it is running at. We have full lighting information!</p><p float=left><img src=content/vct-8th-downsampled-zoom.png width=49%>
<img src=content/vct-8th-sh-zoomed.png width=49%></p><p><em>Left: 1/8th Resolution No SH + Occlusion | Right: 1/8th Resolution with SH</em></p><p>That pipe I pointed out initally, well now we can make it out pretty well!</p><p>We can take the occlusion term we had previously and multiply it with our final upsampled spherical harmonic lighting to get the final results.</p><p><img src=/p/adventures-global-illumination-downscaling/content/vct-8th-sh-and-occlusion.png width=1199 height=713 srcset="/p/adventures-global-illumination-downscaling/content/vct-8th-sh-and-occlusion_hu_bf360a12dd71f2e4.png 480w, /p/adventures-global-illumination-downscaling/content/vct-8th-sh-and-occlusion_hu_e45272e34fff2d2.png 1024w" loading=lazy alt=vct-8th-sh-and-occlusion class=gallery-image data-flex-grow=168 data-flex-basis=403px>
<em>1/8th Resolution + Full Resolution Occlusion (3 upsample passes)</em></p><p>This is currently the best I&rsquo;ve been able to come up with in regards to getting very good and usable results with very low resolution lighting input. Remember, this is all coming from lighting that is calculated at 1/8th screen resolution which originally would have looked like this.</p><p><img src=/p/adventures-global-illumination-downscaling/content/vct-8th-raw.png width=1199 height=713 srcset="/p/adventures-global-illumination-downscaling/content/vct-8th-raw_hu_6f631ba9ef88ed2f.png 480w, /p/adventures-global-illumination-downscaling/content/vct-8th-raw_hu_fcb012209ec4e266.png 1024w" loading=lazy alt=vct-8th-raw class=gallery-image data-flex-grow=168 data-flex-basis=403px>
<em>1/8th Resolution Raw (No Upsampling/Downsampling)</em></p><p>The best part also is that we can actually drop the resolution even lower, and details will still be mostly retained.</p><p><em>NOTE: These screenshots don&rsquo;t have occlusion term factored in.</em></p><p float=left><img src=content/vct-16th-downsampled.png width=49%>
<img src=content/vct-16th-sh.png width=49%></p><p><em>Left: 1/16th Resolution No Spherical Harmonics (4 upsample passes) | Right: 1/16th Resolution With Spherical Harmonics (4 upsample passes)</em></p><p float=left><img src=content/vct-32th-downsampled.png width=49%>
<img src=content/vct-32th-sh.png width=49%></p><p><em>Left: 1/32th Resolution No Spherical Harmonics (5 upsample passes) | Right: 1/32th Resolution With Spherical Harmonics (5 upsample passes)</em></p><h3 id=spherical-harmonic-optimizations-compute-shader><a href=#spherical-harmonic-optimizations-compute-shader class=header-anchor></a>Spherical Harmonic Optimizations: Compute Shader</h3><p>With my inital setup with spherical harmonics, I ran the lighting calculation fragment shader effectively 3 times for each of the spherical harmonic render targets. In addition the upsampling passes would also get multiplied since each of SH render targets needed upsampling to full resolution.</p><p>For inital prototyping and proof of concept it worked fine, but this definetly was not ideal and had some performance degredations.</p><p>One of the things I did to alleviate this was to move both the main lighting calculation, and the upsampling pass into compute shader kernels.</p><p>That way I just execute the main lighting compute shader kernel once, and that would allow me to simultanoeusly write to the 3 SH render targets that I have <em>(Rather than needing to run the lighting calculation fragment shader 3 times)</em>. The same also for the upsampling kernel, simultaneously upsampling the 3 render targets.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-HLSL data-lang=HLSL><span class=line><span class=cl><span class=kt>RWTexture2D</span><span class=o>&lt;</span><span class=kt>float4</span><span class=o>&gt;</span> <span class=n>VoxelConeTraceSHA</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>RWTexture2D</span><span class=o>&lt;</span><span class=kt>float4</span><span class=o>&gt;</span> <span class=n>VoxelConeTraceSHB</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>RWTexture2D</span><span class=o>&lt;</span><span class=kt>float4</span><span class=o>&gt;</span> <span class=n>VoxelConeTraceSHC</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#pragma kernel VoxelConeTracing</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nd>numthreads</span><span class=p>(</span><span class=n>THREAD_GROUP_SIZE_X</span><span class=p>,</span> <span class=n>THREAD_GROUP_SIZE_Y</span><span class=p>,</span> <span class=n>THREAD_GROUP_SIZE_Z</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>VoxelConeTracing</span><span class=p>(</span><span class=kt>uint3</span> <span class=n>id</span> <span class=o>:</span> <span class=nd>SV_DispatchThreadID</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//the 3 float4&#39;s that we will output...</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>irradianceSHA</span> <span class=o>=</span> <span class=kt>float4</span><span class=p>(</span><span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>irradianceSHB</span> <span class=o>=</span> <span class=kt>float4</span><span class=p>(</span><span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float4</span> <span class=n>irradianceSHC</span> <span class=o>=</span> <span class=kt>float4</span><span class=p>(</span><span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>,</span> <span class=mo>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//calculate cone tracing like normal...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//pack the spherical harmonic irradiance coefficents</span>
</span></span><span class=line><span class=cl>    <span class=n>SphericalHarmonicsPackIrradiance_ColorL1</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=c1>//input coefficents</span>
</span></span><span class=line><span class=cl>        <span class=n>irradianceL0</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=n>irradianceL10</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=n>irradianceL11</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=n>irradianceL12</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>//output color</span>
</span></span><span class=line><span class=cl>        <span class=n>irradianceSHA</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>irradianceSHB</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>irradianceSHC</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//output the float4&#39;s simultanoeusly</span>
</span></span><span class=line><span class=cl>    <span class=n>VoxelConeTraceSHA</span><span class=p>[</span><span class=n>id</span><span class=p>.</span><span class=n>xyz</span><span class=p>]</span> <span class=o>=</span> <span class=n>irradianceSHA</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>VoxelConeTraceSHB</span><span class=p>[</span><span class=n>id</span><span class=p>.</span><span class=n>xyz</span><span class=p>]</span> <span class=o>=</span> <span class=n>irradianceSHB</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>VoxelConeTraceSHC</span><span class=p>[</span><span class=n>id</span><span class=p>.</span><span class=n>xyz</span><span class=p>]</span> <span class=o>=</span> <span class=n>irradianceSHC</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=spherical-harmonic-optimizations-render-target-packing><a href=#spherical-harmonic-optimizations-render-target-packing class=header-anchor></a>Spherical Harmonic Optimizations: Render Target Packing</h3><p>I also mentioned that I had 3 SH render targets. Which might not make sense considering we are dealing with Order 1 Spherical Harmonics which leaves you with 4 float3&rsquo;s.</p><ol><li>RGBA Render Target 0<ul><li>R: L0.r</li><li>G: L0.g</li><li>B: L0.b</li><li>A: <em>(Unused)</em></li></ul></li><li>RGBA Render Target 1<ul><li>R: L1X.r</li><li>G: L1X.g</li><li>B: L1X.b</li><li>A: <em>(Unused)</em></li></ul></li><li>RGBA Render Target 2<ul><li>R: L1Y.r</li><li>G: L1Y.g</li><li>B: L1Y.b</li><li>A: <em>(Unused)</em></li></ul></li><li>RGBA Render Target 3<ul><li>R: L1Z.r</li><li>G: L1Z.g</li><li>B: L1Z.b</li><li>A: <em>(Unused)</em></li></ul></li></ol><p>You could have 4 render targets, but that is a bit wasteful memory wise. Turns out we can just pack those 4 float3&rsquo;s into 3 float4&rsquo;s with some basic swizzling. <em>(moving each of the components around)</em></p><p>NOTE: The render targets are RGBA64. Each component is 16 bit half precison, not 8 bit because we are dealing with lighting. We need HDR for proper shading results.</p><ol><li>RGBA Render Target 0<ul><li>R: L0.r</li><li>G: L0.g</li><li>B: L0.b</li><li>A: L1X.r</li></ul></li><li>RGBA Render Target 1<ul><li>R: L1X.g</li><li>G: L1X.b</li><li>B: L1Y.r</li><li>A: L1Y.g</li></ul></li><li>RGBA Render Target 2<ul><li>R: L1Y.b</li><li>G: L1Z.r</li><li>B: L1Z.g</li><li>A: L1Z.b</li></ul></li></ol><p>Now currently I still utilize 3 Render Targets, but this can actually be taken much further as you can do some clever packing techniques to where you can shrink things down to 2 Render Targets.</p><p>Trading color accuracy for luminance, in this case the first Order 0 coefficent remains as is, but Order 1 coefficents store luminance rather than a full RGB color.</p><ol><li>RGBA Render Target 0: (L0.r, L1.g, L1.b, L1X)<ul><li>R: L0.r</li><li>G: L0.g</li><li>B: L0.b</li><li>A: L1X</li></ul></li><li>RGHalf Render Target 1: (L1Y, L1Z)<ul><li>R: L1Y</li><li>G: L1Z</li></ul></li></ol><p>There are likely other clever packing schemes that exist, you are welcome to try them and if it works for you, then do it! <em>(If you also know of any other additional techniques for this please let me know! I&rsquo;m still on the lookout)</em></p><h3 id=spherical-harmonic-bonuses><a href=#spherical-harmonic-bonuses class=header-anchor></a>Spherical Harmonic Bonuses</h3><p>Another bonus of said effects is that since we have information on the lighting environment beyond just a single color now for every pixel.</p><p>With spherical harmonics we can actually do a trick to where we can calculate the dominant direction of light from the SH environment. This dominant direction vector can then be used to derive a specular highlight term that can enhance the quality of our global illumination reflection buffer!</p><p>The dominant direction also in theory can also be used for potentially more things <em>(like localized contact shadows, or micro shadows, etc)</em>.</p><h2 id=future-how-to-go-even-further-and-beyond><a href=#future-how-to-go-even-further-and-beyond class=header-anchor></a>Future: How to go even further and beyond?</h2><p>Where to go from here of course?</p><p>At this point I am mostly satisified with the results, but I am still actively exploring techniques or other avenues to improve results even further.</p><p>A big part of global illumination is specular/reflections. We only looked at diffuse/irradiance here, but often reflections are handled in a seperate pass. SSR is a potential solution here <em>(and a common industry one)</em> but that has obvious drawbacks with only being a screen-space effect. It would be ideal if both diffuse and specular/reflections could be done once in a single pass.</p><p>At the time of writing I have my eyeballs set on radiance caching with octahedron maps.</p><p>Spherical harmonics are great but don&rsquo;t contain enough information to store radiance <em>(or reflection)</em>. Having effectively a low resolution cubemap per pixel <em>(or area)</em> would be more useful. That is where octahedral mapping can come in. That octahedron map can be used for reflections directly, and diffuse/irradiance can also be derived from it using spherical harmonics just like we did before.</p><p>The only issue with the approach is that memory wise it will be considerably heavier, needing to store effectively a cubemap per pixel. Potentially more expensive also since now you are juggling alot more data, and you need very good probe interpolation across pixels.</p><p>I do have a prototype working, but it needs alot more work before I&rsquo;d consider it to be usable and viable. Probe interpolation currently being a difficult problem to solve well.</p><h1 id=references--sources><a href=#references--sources class=header-anchor></a>References / Sources</h1><p>List of references that helped with my implementations and understanding.</p><ul><li><p><a class=link href=https://theinstructionlimit.com/gaussian-blur-revisited-part-one target=_blank rel=noopener>(theinstructionlimit) gaussian-blur-revisited-part-one</a></p></li><li><p><a class=link href=https://theinstructionlimit.com/gaussian-blur-revisited-part-two target=_blank rel=noopener>(theinstructionlimit) gaussian-blur-revisited-part-two</a></p></li><li><p><a class=link href=https://bartwronski.com/2021/02/15/https://bartwronski.com/2021/02/15/bilinear-down-upsampling-pixel-grids-and-that-half-pixel-offset/ target=_blank rel=noopener>(bartwronski) bilinear-down-upsampling-pixel-grids-and-that-half-pixel-offset</a></p></li><li><p><a class=link href=https://c0de517e.blogspot.com/2016/02/downsampled-effects-with-depth-aware.html target=_blank rel=noopener>(c0de517e) downsampled-effects-with-depth-aware</a></p></li><li><p><a class=link href=https://web.archive.org/web/20200819181017/https://eleni.mutantstargoat.com/hikiko/category/igalia/depth-aware-upsampling-experiments/ target=_blank rel=noopener>(hikiko-blog) depth_aware_upsampling_experiments</a></p></li><li><p><a class=link href=https://patapom.com/blog/SHPortal/ target=_blank rel=noopener>(patapom) SHPortal</a></p></li></ul><p><em>By: David Matos</em></p></section><footer class=article-footer><section class=article-tags><a href=/tags/unity3d/>Unity3D</a>
<a href=/tags/diffuse/>Diffuse</a>
<a href=/tags/global-illumination/>Global Illumination</a>
<a href=/tags/lighting/>Lighting</a>
<a href=/tags/upsampling/>Upsampling</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/adventures-spherical-harmonics-coefficent-precision/><div class=article-image><img src=/p/adventures-spherical-harmonics-coefficent-precision/preview-screenshot.d26ea57200ad79d44ac012ef468bd180_hu_5beb074ca49a9d9.png width=250 height=150 loading=lazy alt="Featured image of post Spherical Harmonics Coefficent Precision" data-key=adventures-spherical-harmonics-coefficent-precision data-hash="md5-0m6lcgCtedRKwBLvRovRgA=="></div><div class=article-details><h2 class=article-title>Spherical Harmonics Coefficent Precision</h2></div></a></article><article class=has-image><a href=/p/adventures-box-projected-reflections/><div class=article-image><img src=/p/adventures-box-projected-reflections/5-box-projectedGodotA.cb45bd027accb649982375c1fc22a8e5_hu_113256f2f13e73a0.png width=250 height=150 loading=lazy alt="Featured image of post Box Projected Cubemap Reflections" data-key=adventures-box-projected-reflections data-hash="md5-y0W9AnrMtkmYI3XB/CKo5Q=="></div><div class=article-details><h2 class=article-title>Box Projected Cubemap Reflections</h2></div></a></article></div></div></aside><script src=https://utteranc.es/client.js repo=https://github.com/frostbone25/frostbone25.github.io issue-term=pathname label=comment crossorigin=anonymous async></script><style>.utterances{max-width:unset}</style><script>let utterancesLoaded=!1;function setUtterancesTheme(e){let t=document.querySelector(".utterances iframe");t&&t.contentWindow.postMessage({type:"set-theme",theme:`github-${e}`},"https://utteranc.es")}addEventListener("message",e=>{if(e.origin!=="https://utteranc.es")return;utterancesLoaded=!0,setUtterancesTheme(document.documentElement.dataset.scheme)}),window.addEventListener("onColorSchemeChange",e=>{if(!utterancesLoaded)return;setUtterancesTheme(e.detail)})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2026 David Matos</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.33.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.c922af694cc257bf1ecc41c0dd7b0430f9114ec280ccf67cd2c6ad55f5316c4e.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>